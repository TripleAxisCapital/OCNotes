<!DOCTYPE html>
<html lang="en" class="h-full" data-theme="dark">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>OC Notes â€” Apple-polished</title>
  <meta name="description" content="Apple-style hybrid document + canvas editor with reliable toolbars, eraser, and settings." />
  <meta name="theme-color" content="#0b0b0b" media="(prefers-color-scheme: dark)">
  <meta name="theme-color" content="#f5f5f7" media="(prefers-color-scheme: light)">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

  <!-- Tailwind (CDN) -->
  <script>window.tailwind = { config: { darkMode: 'class' } }</script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          colors: { oc: { accent: '#0A84FF' } },
          borderRadius: { '2.5xl': '1.25rem' },
          boxShadow: {
            glass: '0 1px 0 rgba(255,255,255,0.06) inset, 0 20px 60px rgba(0,0,0,0.35)',
            paper: '0 10px 30px rgba(0,0,0,0.18)'
          }
        }
      }
    }
  </script>

  <!-- Quill -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/quill@1.3.7/dist/quill.snow.css" />
  <script src="https://cdn.jsdelivr.net/npm/quill@1.3.7/dist/quill.min.js"></script>

  <!-- Fabric.js -->
  <script src="https://cdn.jsdelivr.net/npm/fabric@5.3.0/dist/fabric.min.js"></script>

  <!-- Export libs -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html-docx-js/0.4.1/html-docx.js"></script>

  <style>
    :root{
      --bg:#0b0b0b; --text:#ededed; --muted:rgba(255,255,255,0.70);
      --panel:rgba(255,255,255,0.06); --panel-2:rgba(255,255,255,0.10);
      --line:rgba(255,255,255,0.14); --accent:#0A84FF;
      --paper:#111214; --paper-text:#f2f2f2; --paper-edge:rgba(255,255,255,0.08);
      --toolbar-gap:6px; --mobile-side-pad:12px; --pagewrap-pad:16px;
    }
    html[data-theme="light"]{
      --bg:#f5f5f7; --text:#0a0a0a; --muted:rgba(0,0,0,0.65);
      --panel:rgba(255,255,255,0.90); --panel-2:rgba(255,255,255,0.85);
      --line:rgba(0,0,0,0.10); --accent:#0A84FF;
      --paper:#ffffff; --paper-text:#0a0a0a; --paper-edge:rgba(0,0,0,0.08);
    }
    html,body{height:100%; overflow-x:hidden}
    body{background:var(--bg); color:var(--text); -webkit-font-smoothing:antialiased}
    .glass{background:var(--panel); backdrop-filter:blur(12px)}
    .glass-2{background:var(--panel-2); backdrop-filter:blur(12px)}
    ::-webkit-scrollbar{width:10px;height:10px}
    ::-webkit-scrollbar-thumb{background:var(--line);border-radius:999px}
    .z-topbar{z-index:70}.z-drawer{z-index:80}.z-pop{z-index:1000}

    /* Quill polish */
    .ql-toolbar.ql-snow{
      border:1px solid var(--line) !important;
      background:var(--panel-2) !important;
      color:var(--text) !important;
    }
    .ql-container.ql-snow{ border:1px solid var(--line); background:transparent }
    .ql-editor{ color:var(--paper-text) }

    /* Toolbar shell (= never overlaps, scrolls if crowded) */
    .toolbar-shell{ display:flex; align-items:center; gap:var(--toolbar-gap); overflow-x:auto; flex-wrap:nowrap }
    .toolbar-shell > *{ flex-shrink:0; white-space:nowrap }

    /* Page */
    #pageWrap{ display:flex; justify-content:center; padding:var(--pagewrap-pad) }
    #page{ width:816px; min-height:1056px; background:var(--paper); color:var(--paper-text);
           border:1px solid var(--paper-edge); border-radius:12px; box-shadow:var(--shadow-paper); transform-origin:top center }
    #page .ql-editor{ min-height:calc(1056px - 2in); padding:1in; font-size:16px; line-height:1.6 }

    /* Canvas */
    .canvas-toolbar{ overflow-x:auto; white-space:nowrap }
    .tool-active{ background:#0A84FF !important; color:#fff !important; border-color:#ffffff33 !important }

    @media (max-width: 768px){
      :root{ --pagewrap-pad: var(--mobile-side-pad) }
    }
  </style>
</head>
<body class="h-full">
  <!-- Top bar -->
  <header class="sticky top-0 z-topbar">
    <div class="glass border-b" style="border-color:var(--line)">
      <div class="w-full flex items-center justify-between gap-3 px-4 py-2">
        <div class="flex items-center gap-3 min-w-0">
          <div class="w-8 h-8 rounded-xl bg-white/90 text-black grid place-content-center font-bold flex-shrink-0">OC</div>
          <div class="leading-tight truncate">
            <div class="truncate"><strong>OC Notes</strong></div>
            <div class="text-xs" style="color:var(--muted)">Apple-clean document & canvas</div>
          </div>
        </div>
        <div class="hidden lg:flex items-center gap-2">
          <button id="toggleSidebar" class="px-3 py-2 glass-2 rounded-xl border text-sm" style="border-color:var(--line)">History</button>
          <button id="newBtn"   class="px-3 py-2 glass-2 rounded-xl border text-sm" style="border-color:var(--line)">New</button>
          <button id="openBtn"  class="px-3 py-2 glass-2 rounded-xl border text-sm" style="border-color:var(--line)">Openâ€¦</button>
          <button id="saveBtn"  class="px-3 py-2 glass-2 rounded-xl border text-sm" style="border-color:var(--line)">Save âŒ˜S</button>

          <div class="relative">
            <button id="exportBtn" class="px-3 py-2 glass-2 rounded-xl border text-sm" style="border-color:var(--line)">Export â–¼</button>
          </div>

          <div class="ml-2 flex items-center rounded-xl glass-2 border overflow-hidden" style="border-color:var(--line)">
            <button id="modeDoc" class="px-3 py-2 text-sm bg-white/10">Document</button>
            <button id="modeCanvas" class="px-3 py-2 text-sm hover:bg-white/10">Canvas</button>
            <button id="modeSettings" class="px-3 py-2 text-sm hover:bg-white/10">Settings</button>
          </div>

          <button id="themeBtn" title="Toggle Light/Dark" class="ml-2 px-3 py-2 glass-2 rounded-xl border text-sm" style="border-color:var(--line)">â˜€ï¸Ž/ðŸŒ™</button>
        </div>

        <button id="menuBtn" class="lg:hidden px-3 py-2 glass-2 rounded-xl border text-sm" style="border-color:var(--line)">â˜°</button>
      </div>
    </div>
  </header>

  <!-- Title -->
  <section class="max-w-[1200px] mx-auto px-4 mt-3">
    <div class="flex items-center gap-2">
      <div class="glass-2 border rounded-2xl px-3 py-1.5 w-full md:w-auto" style="border-color:var(--line)">
        <input id="docTitle" class="bg-transparent outline-none text-lg md:text-xl font-semibold w-full" placeholder="Untitled note" />
      </div>
      <span id="dirtyDot" class="w-2.5 h-2.5 rounded-full bg-rose-400/80 hidden" title="Unsaved changes"></span>
    </div>
  </section>

  <!-- Main -->
  <main class="max-w-[1200px] mx-auto px-4 mt-2">
    <!-- Document -->
    <div id="docPanel" class="space-y-3">
      <!-- âœ… Quill toolbar container with required classes -->
      <div id="quillToolbar" class="rounded-2xl">
        <div id="quillToolbarShell" class="ql-toolbar ql-snow glass border rounded-2xl toolbar-shell" style="border-color:var(--line)">
          <!-- Filled by renderQuillToolbar() -->
        </div>
      </div>

      <div id="pageWrap" class="glass border rounded-2xl" style="border-color:var(--line)">
        <div id="page"><div id="quillEditor"></div></div>
      </div>
    </div>

    <!-- Canvas -->
    <div id="canvasPanel" class="hidden">
      <div id="canvasToolDock" class="canvas-toolbar glass rounded-2xl border p-2 flex items-center gap-2" style="border-color:var(--line)">
        <button class="tool px-3 py-1.5 glass-2 border rounded-lg text-sm" data-tool="select" style="border-color:var(--line)">Move</button>
        <button class="tool px-3 py-1.5 glass-2 border rounded-lg text-sm" data-tool="text"   style="border-color:var(--line)">Text</button>
        <button class="tool px-3 py-1.5 glass-2 border rounded-lg text-sm" data-tool="sticky" style="border-color:var(--line)">Sticky</button>
        <button class="tool px-3 py-1.5 glass-2 border rounded-lg text-sm" data-tool="draw"   style="border-color:var(--line)">Pen</button>
        <button class="tool px-3 py-1.5 glass-2 border rounded-lg text-sm" data-tool="erase"  style="border-color:var(--line)">Erase</button>

        <div class="ml-2 flex items-center gap-2">
          <label class="text-sm" style="color:var(--muted)">Brush</label>
          <input id="brushSize" type="range" min="1" max="24" value="3" />
        </div>

        <div class="ml-2 flex items-center gap-2">
          <label class="text-sm" style="color:var(--muted)">Color</label>
          <input id="brushColor" type="color" value="#ffffff" class="w-9 h-9 p-0 bg-transparent border rounded-lg" style="border-color:var(--line)" />
        </div>

        <div class="ml-4 flex items-center gap-2">
          <label class="text-sm" style="color:var(--muted)">Grid</label>
          <input id="gridToggle" type="checkbox" />
          <label class="text-sm" style="color:var(--muted)">Snap</label>
          <input id="snapToggle" type="checkbox" />
          <label class="text-sm" style="color:var(--muted)">Size</label>
          <input id="gridSize" type="number" value="24" min="4" max="200" class="w-16 glass-2 border rounded-lg px-2 py-1 text-sm" style="border-color:var(--line)" />
        </div>

        <div class="ml-4 flex items-center gap-2">
          <label class="text-sm" style="color:var(--muted)">Canvas BG</label>
          <input id="canvasBg" type="color" value="#0f0f11" class="w-9 h-9 p-0 bg-transparent border rounded-lg" style="border-color:var(--line)" />
        </div>

        <div class="ml-auto flex items-center gap-2">
          <button id="zoomOut" class="px-3 py-1.5 glass-2 rounded-lg border text-sm" style="border-color:var(--line)">âˆ’</button>
          <input id="zoomLevel" type="number" class="w-16 glass-2 border rounded-lg px-2 py-1 text-sm" style="border-color:var(--line)" value="100" />%
          <button id="zoomIn" class="px-3 py-1.5 glass-2 rounded-lg border text-sm" style="border-color:var(--line)">+</button>
          <button id="centerCanvas" class="px-3 py-1.5 glass-2 rounded-lg border text-sm" style="border-color:var(--line)">Center</button>
          <button id="clearCanvas" class="px-3 py-1.5 glass-2 rounded-lg border text-sm" style="border-color:var(--line)">Clear</button>
        </div>
      </div>

      <div id="canvasHost" class="glass rounded-2xl border mt-3 overflow-hidden" style="border-color:var(--line); position:relative">
        <canvas id="ocCanvas"></canvas>
      </div>
    </div>

    <!-- Settings -->
    <div id="settingsPanel" class="hidden">
      <div class="glass rounded-2xl border p-4 md:p-6" style="border-color:var(--line)">
        <h2 class="text-xl font-semibold mb-3">Settings</h2>
        <div class="grid md:grid-cols-2 gap-4">
          <div class="glass-2 border rounded-xl p-3" style="border-color:var(--line)">
            <div class="font-medium mb-2">Mobile document side padding</div>
            <div class="text-sm mb-3" style="color:var(--muted)">Default: 12px</div>
            <div class="flex items-center gap-2">
              <input id="setMobilePad" type="range" min="8" max="28" step="1" class="w-56" />
              <input id="setMobilePadNumber" type="number" min="8" max="28" step="1" class="w-16 glass-2 border rounded-lg px-2 py-1 text-sm" style="border-color:var(--line)" />
              <span class="text-sm" style="color:var(--muted)">px</span>
            </div>
          </div>
          <div class="glass-2 border rounded-xl p-3" style="border-color:var(--line)">
            <div class="font-medium mb-2">Interface density</div>
            <div class="flex gap-2">
              <button id="densityCozy" class="px-3 py-2 glass-2 rounded-xl border text-sm" style="border-color:var(--line)">Cozy</button>
              <button id="densityCompact" class="px-3 py-2 glass-2 rounded-xl border text-sm" style="border-color:var(--line)">Compact</button>
            </div>
          </div>
        </div>
        <div class="mt-6 flex items-center justify-end gap-2">
          <button id="settingsBack" class="px-3 py-2 glass-2 rounded-xl border text-sm" style="border-color:var(--line)">Back</button>
          <button id="settingsApply" class="px-3 py-2 glass-2 rounded-xl border text-sm" style="border-color:var(--line)">Apply</button>
        </div>
      </div>
    </div>
  </main>

  <!-- History Drawer -->
  <div id="historyDrawer" class="fixed inset-0 hidden z-drawer">
    <div class="absolute inset-0 bg-black/50" data-close-history></div>
    <div class="absolute left-0 top-0 h-full w-[360px] glass border-r p-4 overflow-y-auto" style="border-color:var(--line)">
      <div class="flex items-center justify-between mb-3">
        <h3 class="text-lg font-semibold">Workspaces</h3>
        <div class="flex items-center gap-2">
          <button id="drawerNew" class="px-3 py-1.5 glass-2 rounded-lg border text-sm" style="border-color:var(--line)">New</button>
          <button data-close-history class="px-3 py-1.5 glass-2 rounded-lg border text-sm" style="border-color:var(--line)">Close</button>
        </div>
      </div>
      <div class="mb-3">
        <input id="searchHistory" placeholder="Searchâ€¦" class="w-full glass-2 border rounded-xl px-3 py-2 outline-none" style="border-color:var(--line)" />
      </div>
      <div id="historyList" class="space-y-2"></div>
    </div>
  </div>

  <!-- Sidebar (desktop) -->
  <aside id="sidebarDock" class="hidden lg:block fixed left-0 top-[64px] bottom-0 w-[300px] px-3">
    <div class="glass rounded-2xl border p-3 h-full" style="border-color:var(--line)">
      <div class="flex items-center gap-2 mb-2">
        <button id="sbNew" class="px-3 py-2 glass-2 rounded-xl border text-sm" style="border-color:var(--line)">New</button>
        <input id="sidebarSearch" placeholder="Search notesâ€¦" class="w-full glass-2 border rounded-xl px-3 py-2 outline-none" style="border-color:var(--line)" />
      </div>
      <div id="sidebarList" class="space-y-2 pr-1 h-[calc(100%-44px)] overflow-auto"></div>
    </div>
  </aside>

  <!-- Hidden input + export menu portal -->
  <input id="openFile" type="file" accept=".ocnote,application/json" class="hidden" />
  <div id="exportMenu" class="hidden fixed z-pop menu-panel w-56 glass border rounded-xl overflow-hidden" style="border-color:var(--line)"></div>

  <script>
    /*************** tiny helpers ***************/
    const $  = (s, el=document)=> el.querySelector(s);
    const $$ = (s, el=document)=> Array.from(el.querySelectorAll(s));
    const uid= ()=> 'oc_' + Math.random().toString(36).slice(2) + Date.now().toString(36);
    const clamp = (v,a,b)=> Math.max(a,Math.min(b,v));
    const niceDate = iso => { try { return new Date(iso).toLocaleString(); } catch { return iso; } };
    const flash = (msg, ms=1600) => {
      const d=document.createElement('div');
      d.textContent=msg; d.className='fixed bottom-5 left-1/2 -translate-x-1/2 px-4 py-2 rounded-xl glass border';
      d.style.borderColor=getComputedStyle(document.body).getPropertyValue('--line');
      document.body.appendChild(d); setTimeout(()=>d.remove(), ms);
    };

    const store = {
      key:'oc_notes_history_v5', themeKey:'oc_theme', settingsKey:'oc_settings_v1',
      loadAll(){ try{return JSON.parse(localStorage.getItem(this.key))||[]}catch{return[]} },
      saveAll(v){ localStorage.setItem(this.key, JSON.stringify(v)); },
      upsert(doc){ const a=this.loadAll(); const i=a.findIndex(x=>x.id===doc.id); if(i>=0)a[i]=doc; else a.unshift(doc); this.saveAll(a.slice(0,25)); },
      loadTheme(){ return localStorage.getItem(this.themeKey); }, saveTheme(v){ localStorage.setItem(this.themeKey,v); },
      loadSettings(){ try{return Object.assign({mobileSidePad:12,density:'cozy'}, JSON.parse(localStorage.getItem(this.settingsKey))||{})}catch{return {mobileSidePad:12,density:'cozy'}} },
      saveSettings(s){ localStorage.setItem(this.settingsKey, JSON.stringify(s)); }
    };

    const state = {
      id: uid(), mode:'doc', dirty:false, quill:null, canvas:null,
      hist:{stack:[], idx:-1}, zoom:1, grid:{show:false,snap:false,size:24},
      settings: store.loadSettings()
    };

    const markDirty = ()=>{ state.dirty=true; $('#dirtyDot').classList.remove('hidden'); };
    const clearDirty= ()=>{ state.dirty=false; $('#dirtyDot').classList.add('hidden'); };

    function applyTheme(t){ document.documentElement.setAttribute('data-theme', t); store.saveTheme(t); }
    function toggleTheme(){ applyTheme( (document.documentElement.getAttribute('data-theme')||'dark')==='dark' ? 'light':'dark' ); }

    /*************** Quill ***************/
    function renderQuillToolbar(){
      const shell = $('#quillToolbarShell');
      shell.innerHTML = `
        <span class="ql-formats">
          <select class="ql-font">
            <option selected value="sans">System</option>
            <option value="serif">Serif</option>
            <option value="monospace">Mono</option>
          </select>
          <select class="ql-size">
            <option value="small"></option>
            <option value="normal" selected></option>
            <option value="large"></option>
            <option value="huge"></option>
          </select>
          <select class="ql-header">
            <option selected></option><option value="1">H1</option><option value="2">H2</option><option value="3">H3</option>
          </select>
        </span>
        <span class="ql-formats">
          <button class="ql-bold"></button><button class="ql-italic"></button><button class="ql-underline"></button><button class="ql-strike"></button>
        </span>
        <span class="ql-formats">
          <button class="ql-list" value="ordered"></button><button class="ql-list" value="bullet"></button>
          <select class="ql-align"></select>
        </span>
        <span class="ql-formats">
          <button class="ql-link"></button><button class="ql-image"></button><button class="ql-code-block"></button>
        </span>
        <span class="ql-formats"><button class="ql-clean"></button></span>
        <span class="ql-formats">
          <button id="docInsertInvoice" class="px-2 py-1 text-sm rounded-lg glass-2 border" style="border-color:var(--line)">Invoice</button>
        </span>
      `;
    }

    function initQuill(){
      if (!window.Quill) throw new Error('Quill failed to load');
      renderQuillToolbar();
      const q = new Quill('#quillEditor', { theme:'snow', modules:{ toolbar:'#quillToolbarShell' } });
      state.quill = q;
      q.on('text-change', markDirty);
      $('#docInsertInvoice')?.addEventListener('click', () => {
        const html = `
          <div class="doc-widget" style="border:1px solid var(--line); border-radius:12px; padding:8px; margin:12px 0;">
            <div style="text-align:center; font-weight:700; font-size:22px; margin-bottom:8px; color:var(--accent)">INVOICE</div>
            <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px; margin-bottom:12px;">
              <div contenteditable="true">From:<br>Your Company<br>Address</div>
              <div contenteditable="true">Bill To:<br>Client Name<br>Address</div>
            </div>
            <div style="display:grid; grid-template-columns: 2fr 1fr 1fr 1fr;">
              <div style="font-weight:600;border:1px solid var(--line);padding:8px">Item</div>
              <div style="font-weight:600;border:1px solid var(--line);padding:8px">Qty</div>
              <div style="font-weight:600;border:1px solid var(--line);padding:8px">Price</div>
              <div style="font-weight:600;border:1px solid var(--line);padding:8px">Amount</div>
            </div>
            ${Array.from({length:4}).map(()=>`
              <div style="display:grid; grid-template-columns: 2fr 1fr 1fr 1fr;">
                <div contenteditable="true" style="border:1px solid var(--line);padding:8px"><br/></div>
                <div contenteditable="true" style="border:1px solid var(--line);padding:8px"><br/></div>
                <div contenteditable="true" style="border:1px solid var(--line);padding:8px"><br/></div>
                <div contenteditable="true" style="border:1px solid var(--line);padding:8px"><br/></div>
              </div>`).join('')}
            <div style="display:grid; grid-template-columns: 2fr 1fr 1fr; gap:12px; align-items:center; margin-top:12px">
              <div contenteditable="true" style="border:1px solid var(--line);padding:8px">Notes</div>
              <div style="text-align:right; font-weight:600">Total:</div>
              <div contenteditable="true" style="border:1px solid var(--line);padding:8px">$0.00</div>
            </div>
          </div>`;
        q.clipboard.dangerouslyPasteHTML(q.getSelection()?.index ?? q.getLength(), html);
        markDirty();
      });
    }

    /*************** Fabric Canvas (with robust Eraser) ***************/
    function initCanvas(){
      if (!window.fabric) throw new Error('Fabric failed to load');
      const cEl = $('#ocCanvas'), host = $('#canvasHost');
      const canvas = new fabric.Canvas(cEl, {
        backgroundColor:null, selection:true, preserveObjectStacking:true, perPixelTargetFind:true, targetFindTolerance:10
      });
      state.canvas = canvas;

      function resize(){
        const w = host.clientWidth || window.innerWidth;
        const h = Math.max(600, window.innerHeight - 260);
        cEl.width = w; cEl.height = h;
        canvas.setWidth(w); canvas.setHeight(h);
        canvas.requestRenderAll();
      }
      resize(); window.addEventListener('resize', ()=>requestAnimationFrame(resize));

      // default brush
      canvas.isDrawingMode = false;
      canvas.freeDrawingBrush.width = 3;
      canvas.freeDrawingBrush.color = '#ffffff';

      // eraser tool setup
      function setEraseBrush(){
        canvas.isDrawingMode = true;
        if (fabric.EraserBrush) {
          canvas.freeDrawingBrush = new fabric.EraserBrush(canvas);
          canvas.freeDrawingBrush.width = Number($('#brushSize').value || 12);
        } else {
          canvas.freeDrawingBrush = new fabric.PencilBrush(canvas);
          canvas.freeDrawingBrush.width = Number($('#brushSize').value || 12);
          canvas.freeDrawingBrush.color = 'rgba(0,0,0,1)';
        }
        canvas.defaultCursor = 'crosshair';
      }

      // path handling
      canvas.on('path:created', (e) => {
        const p = e.path, tool = state.currentTool;
        if (tool === 'erase') {
          if (!fabric.EraserBrush) {
            p.globalCompositeOperation = 'destination-out';
            p.stroke = 'rgba(0,0,0,1)';
            p.fill = null; p.selectable=false; p.evented=false; p.strokeUniform=true;
          }
          markDirty(); return;
        }
        p.set({ fill:null, stroke: $('#brushColor').value || '#ffffff', strokeWidth: Number($('#brushSize').value || 3),
                selectable:true, evented:true, strokeUniform:true, erasable:true });
        markDirty();
      });

      // tools
      function useTool(kind){
        state.currentTool = kind;
        canvas.isDrawingMode = false;
        canvas.selection = (kind === 'select');
        $$('#canvasPanel .tool').forEach(b => b.classList.toggle('tool-active', b.dataset.tool === kind));
        if (kind === 'draw'){
          canvas.isDrawingMode = true;
          if (!(canvas.freeDrawingBrush instanceof fabric.PencilBrush)) canvas.freeDrawingBrush = new fabric.PencilBrush(canvas);
          canvas.freeDrawingBrush.color = $('#brushColor').value || '#ffffff';
          canvas.freeDrawingBrush.width = Number($('#brushSize').value || 3);
          return;
        }
        if (kind === 'erase'){ setEraseBrush(); return; }
      }
      // expose for buttons
      $$('#canvasPanel .tool').forEach(btn => btn.addEventListener('click', () => useTool(btn.dataset.tool)));
      useTool('select');

      // text & sticky
      canvas.on('mouse:down', (opt) => {
        const pt = canvas.getPointer(opt.e);
        if (state.currentTool === 'text') {
          const tb = new fabric.Textbox('', { left:pt.x, top:pt.y, width:320, fontSize:20, fill: $('#brushColor').value || '#fff',
                                              backgroundColor:'rgba(255,255,255,0.05)', padding:8, erasable:true });
          canvas.add(tb); canvas.setActiveObject(tb); tb.enterEditing(); markDirty();
        } else if (state.currentTool === 'sticky') {
          const st = new fabric.Textbox('', { left:pt.x, top:pt.y, width:260, fontSize:18, fill:'#1f2937',
                                              backgroundColor:'#facc15', padding:10, rx:12, ry:12, erasable:true });
          canvas.add(st); canvas.setActiveObject(st); st.enterEditing(); markDirty();
        }
      });

      // controls
      $('#brushSize').addEventListener('input', e => {
        const sz = Number(e.target.value||3);
        if (canvas.isDrawingMode) canvas.freeDrawingBrush.width = sz;
        (canvas.getActiveObjects()||[]).forEach(o => { if (o.type==='path') o.set({strokeWidth:sz}); });
        canvas.requestRenderAll();
      });
      $('#brushColor').addEventListener('input', e => {
        const col = e.target.value || '#ffffff';
        if (state.currentTool !== 'erase' && canvas.freeDrawingBrush.color !== undefined) canvas.freeDrawingBrush.color = col;
        (canvas.getActiveObjects()||[]).forEach(o => { if (o.type==='path') o.set({stroke:col}); if (/text/.test(o.type)) o.set({fill:col}); });
        canvas.requestRenderAll();
      });
      $('#canvasBg').addEventListener('input', e => { $('#canvasHost').style.backgroundColor = e.target.value || '#0f0f11'; });

      $('#clearCanvas').addEventListener('click', () => { if (confirm('Clear the canvas?')) { canvas.clear(); markDirty(); } });
      $('#zoomIn').addEventListener('click', () => setZoom(state.zoom * 1.15));
      $('#zoomOut').addEventListener('click', () => setZoom(state.zoom / 1.15));
      $('#centerCanvas').addEventListener('click', () => { state.zoom=1; canvas.setViewportTransform([1,0,0,1,0,0]); canvas.requestRenderAll(); $('#zoomLevel').value=100; });
      $('#zoomLevel').addEventListener('change', e => setZoom(clamp((Number(e.target.value)||100)/100, 0.1, 5)));
      function setZoom(z){ state.zoom=clamp(z,0.1,5); const p=new fabric.Point(canvas.getWidth()/2, canvas.getHeight()/2); canvas.zoomToPoint(p,state.zoom); $('#zoomLevel').value=Math.round(state.zoom*100); }

      // grid overlay
      canvas.on('after:render', () => {
        if (!state.grid.show) return;
        const ctx = canvas.getContext(), zoom = canvas.getZoom(), size = state.grid.size * zoom;
        ctx.save(); ctx.strokeStyle='rgba(255,255,255,0.08)'; ctx.lineWidth=1;
        for (let x=0; x<canvas.getWidth(); x+=size){ ctx.beginPath(); ctx.moveTo(x,0); ctx.lineTo(x,canvas.getHeight()); ctx.stroke(); }
        for (let y=0; y<canvas.getHeight(); y+=size){ ctx.beginPath(); ctx.moveTo(0,y); ctx.lineTo(canvas.getWidth(),y); ctx.stroke(); }
        ctx.restore();
      });
      $('#gridToggle').addEventListener('change', e => { state.grid.show = e.target.checked; canvas.requestRenderAll(); });
      $('#snapToggle').addEventListener('change', e => { state.grid.snap = e.target.checked; });
      $('#gridSize').addEventListener('change', e => { state.grid.size = clamp(Number(e.target.value)||24, 4, 200); canvas.requestRenderAll(); });

      // snap on move
      function maybeSnap(target){
        if (!state.grid.snap) return;
        const gs = state.grid.size;
        target.set({ left: Math.round(target.left/gs)*gs, top: Math.round(target.top/gs)*gs });
      }
      canvas.on('object:moving', e => maybeSnap(e.target));
      canvas.on('object:scaling', e => maybeSnap(e.target));
    }

    /*************** Modes & UI wiring ***************/
    function setMode(m){
      state.mode = m;
      $('#docPanel').classList.toggle('hidden', m!=='doc');
      $('#canvasPanel').classList.toggle('hidden', m!=='canvas');
      $('#settingsPanel').classList.toggle('hidden', m!=='settings');
      $('#modeDoc').classList.toggle('bg-white/10', m==='doc');
      $('#modeCanvas').classList.toggle('bg-white/10', m==='canvas');
      $('#modeSettings').classList.toggle('bg-white/10', m==='settings');
      if (m==='doc') fitDoc();
    }

    function fitDoc(){
      const wrap = $('#pageWrap'), page = $('#page');
      const header = document.querySelector('header');
      const tb = $('#quillToolbar');
      const titleSec = $('#docTitle')?.closest('section');
      const availH = Math.max(400, window.innerHeight - (header?.offsetHeight||0) - (tb?.offsetHeight||0) - (titleSec?.offsetHeight||0) - 48);
      const availW = Math.max(320, wrap.clientWidth);
      const scale = Math.min(availW/816, availH/1056, 1);
      page.style.transform = `scale(${scale})`;
      wrap.style.minHeight = Math.ceil(1056*scale + 24) + 'px';
    }

    /*************** History / Save / Export ***************/
    function getSnapshot(){
      const title = ($('#docTitle').value || '').trim() || 'Untitled note';
      const docHTML = state.quill ? state.quill.root.innerHTML : '';
      let canvasJSON=null, canvasPNG=null, canvasBG=$('#canvasBg')?.value || '#0f0f11';
      if (state.canvas){
        canvasJSON = state.canvas.toJSON(['selectable','evented','stroke','strokeWidth','fill','fontSize','backgroundColor','padding','rx','ry','strokeUniform','globalCompositeOperation']);
        try{ canvasPNG = state.canvas.toDataURL({ format:'png', multiplier:2, quality:1.0 }); } catch{}
      }
      return { id:state.id, title, updatedAt:new Date().toISOString(), docHTML, canvasJSON, canvasPNG, canvasBG, version:7 };
    }
    function applySnapshot(snap){
      state.id = snap.id || uid();
      $('#docTitle').value = snap.title || 'Untitled note';
      if (state.quill) state.quill.root.innerHTML = snap.docHTML || '';
      if (state.canvas && snap.canvasJSON){
        state.canvas.loadFromJSON(snap.canvasJSON, ()=> state.canvas.requestRenderAll());
        $('#canvasHost').style.backgroundColor = snap.canvasBG || '#0f0f11';
      }
      clearDirty(); refreshHistoryUI(); refreshSidebarUI();
    }
    function saveDocument(){ store.upsert(getSnapshot()); clearDirty(); flash('Saved'); refreshHistoryUI(); refreshSidebarUI(); }
    function newDocument(){
      if (state.dirty && !confirm('Discard unsaved changes?')) return;
      state.id = uid(); $('#docTitle').value='Untitled note'; state.quill && (state.quill.root.innerHTML='');
      state.canvas && state.canvas.clear(); clearDirty(); const s=getSnapshot(); store.upsert(s);
      refreshHistoryUI(); refreshSidebarUI();
    }
    function importProject(file){
      const reader = new FileReader();
      reader.onload = ()=>{ try{ applySnapshot(JSON.parse(reader.result)); saveDocument(); }catch{ alert('Invalid file.'); } };
      reader.readAsText(file);
    }

    function buildStandaloneHTML(snap){
      const css = `body{font-family:-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;color:#111;margin:40px;line-height:1.6;}
      h1{font-size:28px;margin:0 0 16px;} h2{font-size:20px;margin:24px 0 8px;}
      .doc{font-size:16px;} img.canvas-shot{max-width:100%;height:auto;margin:16px 0;border:1px solid #e5e5e5;border-radius:8px;}
      .ql-align-center{text-align:center}.ql-align-right{text-align:right}.ql-align-justify{text-align:justify}`;
      const doc = `<div class="doc">${snap.docHTML||''}</div>`;
      const canvas = snap.canvasPNG ? `<h2>Canvas</h2><img class="canvas-shot" src="${snap.canvasPNG}" alt="Canvas" />` : '';
      return `<!DOCTYPE html><html><head><meta charset="utf-8"><title>${(snap.title||'Note').replace(/[&<>"]/g,'')}</title><style>${css}</style></head><body><h1>${(snap.title||'Note').replace(/[&<>"]/g,'')}</h1>${doc}${canvas}</body></html>`;
    }
    async function exportDocx(){ const snap=getSnapshot(); const html=buildStandaloneHTML(snap); let blob=window.htmlDocx.asBlob(html); if (!blob.type) blob=new Blob([blob],{type:'application/vnd.openxmlformats-officedocument.wordprocessingml.document'}); downloadBlob(blob, safeName(snap.title)+'.docx'); }
    async function exportPDF(){ const snap=getSnapshot(); const html=buildStandaloneHTML(snap); await html2pdf().set({ margin:[10,10,10,10], filename:safeName(snap.title)+'.pdf', image:{type:'jpeg',quality:0.98}, html2canvas:{scale:2, useCORS:true}, jsPDF:{unit:'mm',format:'letter',orientation:'portrait'} }).from(html).save(); }
    function exportHTML(){ const snap=getSnapshot(); const html=buildStandaloneHTML(snap); downloadBlob(new Blob([html],{type:'text/html;charset=utf-8'}), safeName(snap.title)+'.html'); }
    function exportJSON(){ const snap=getSnapshot(); downloadBlob(new Blob([JSON.stringify(snap,null,2)],{type:'application/json'}), safeName(snap.title)+'.ocnote'); }
    function safeName(n){ return (n||'note').replace(/[^a-z0-9\-]+/gi,'_'); }
    async function downloadBlob(blob, filename){ const a=document.createElement('a'); const url=URL.createObjectURL(blob); a.href=url; a.download=filename; document.body.appendChild(a); a.click(); a.remove(); setTimeout(()=>URL.revokeObjectURL(url), 3000); }

    function refreshHistoryUI(){
      const list = store.loadAll(); const q = ($('#searchHistory')?.value||'').toLowerCase();
      const holder = $('#historyList'); if (!holder) return; holder.innerHTML='';
      list.filter(x => !q || (x.title?.toLowerCase().includes(q) || (x.docHTML||'').toLowerCase().includes(q))).forEach(item=>{
        const row = document.createElement('div');
        row.className = 'glass rounded-xl border p-3'; row.style.borderColor = getComputedStyle(document.body).getPropertyValue('--line');
        row.innerHTML = `<div class="flex items-center justify-between gap-3">
          <div class="min-w-0"><div class="font-medium truncate">${item.title||'Untitled'}</div><div class="text-xs" style="color:var(--muted)">${niceDate(item.updatedAt)}</div></div>
          <div class="flex items-center gap-2 flex-shrink-0">
            <button class="px-2 py-1 glass-2 rounded-lg text-xs border" data-open="${item.id}" style="border-color:var(--line)">Open</button>
            <button class="px-2 py-1 glass-2 rounded-lg text-xs border" data-dl="${item.id}" style="border-color:var(--line)">Export</button>
          </div></div>`;
        holder.appendChild(row);
      });
      holder.querySelectorAll('[data-open]').forEach(b => b.addEventListener('click', () => {
        const id = b.getAttribute('data-open'); const item = store.loadAll().find(x=>x.id===id); item && applySnapshot(item);
        $('#historyDrawer').classList.add('hidden'); document.body.style.overflow='';
      }));
      holder.querySelectorAll('[data-dl]').forEach(b => b.addEventListener('click', () => {
        const id = b.getAttribute('data-dl'); const item = store.loadAll().find(x=>x.id===id);
        if (item) downloadBlob(new Blob([JSON.stringify(item,null,2)], {type:'application/json'}), safeName(item.title)+'.ocnote');
      }));
    }
    function refreshSidebarUI(){
      const list = store.loadAll(); const q = ($('#sidebarSearch')?.value||'').toLowerCase();
      const holder = $('#sidebarList'); if (!holder) return; holder.innerHTML='';
      const currentId = state.id;
      list.filter(x => !q || (x.title?.toLowerCase().includes(q) || (x.docHTML||'').toLowerCase().includes(q))).forEach(item=>{
        const row=document.createElement('div'); row.className='glass-2 rounded-xl border p-3 cursor-pointer'; row.style.borderColor=getComputedStyle(document.body).getPropertyValue('--line');
        if (item.id===currentId) row.style.outline='1px solid var(--line)';
        row.innerHTML = `<div class="text-sm font-medium truncate">${item.title||'Untitled'}</div><div class="text-[11px]" style="color:var(--muted)">${niceDate(item.updatedAt)}</div>`;
        row.addEventListener('click', ()=> applySnapshot(item));
        holder.appendChild(row);
      });
    }

    /*************** Menus & wiring ***************/
    function wireMenus(){
      const expBtn = $('#exportBtn'), expMenu = $('#exportMenu');
      function openExportMenu(){
        expMenu.innerHTML = `
          <button class="block w-full text-left px-3 py-2 border-b" style="border-color:var(--line)" data-k="docx">Export .docx (Word)</button>
          <button class="block w-full text-left px-3 py-2 border-b" style="border-color:var(--line)" data-k="pdf">Export .pdf</button>
          <button class="block w-full text-left px-3 py-2 border-b" style="border-color:var(--line)" data-k="html">Export .html</button>
          <button class="block w-full text-left px-3 py-2" data-k="json">Export project (.ocnote)</button>`;
        expMenu.classList.remove('hidden');
        requestAnimationFrame(()=> {
          const r = expBtn.getBoundingClientRect();
          const w = expMenu.getBoundingClientRect().width || 224;
          const left = Math.min(Math.max(12, r.right - w), window.innerWidth - w - 12);
          expMenu.style.top = (r.bottom + 8) + 'px';
          expMenu.style.left = left + 'px';
        });
      }
      function closeExportMenu(){ expMenu.classList.add('hidden'); }
      expBtn.addEventListener('click', e => { e.stopPropagation(); expMenu.classList.contains('hidden') ? openExportMenu() : closeExportMenu(); });
      document.addEventListener('click', () => closeExportMenu());
      document.addEventListener('keydown', e => { if (e.key==='Escape') closeExportMenu(); });
      expMenu.addEventListener('click', ev => {
        const k = ev.target.getAttribute('data-k'); if (!k) return; closeExportMenu();
        if (k==='docx') exportDocx(); if (k==='pdf') exportPDF(); if (k==='html') exportHTML(); if (k==='json') exportJSON();
      });

      // history drawer
      $('#menuBtn')?.addEventListener('click', ()=>{ $('#historyDrawer').classList.remove('hidden'); document.body.style.overflow='hidden'; refreshHistoryUI(); });
      $$('#historyDrawer [data-close-history]').forEach(el => el.addEventListener('click', ()=>{ $('#historyDrawer').classList.add('hidden'); document.body.style.overflow=''; }));

      // top actions
      $('#newBtn').addEventListener('click', newDocument);
      $('#openBtn').addEventListener('click', ()=> $('#openFile').click());
      $('#openFile').addEventListener('change', e => { const f=e.target.files?.[0]; if (f) importProject(f); e.target.value=''; });
      $('#saveBtn').addEventListener('click', saveDocument);

      $('#modeDoc').addEventListener('click', ()=> setMode('doc'));
      $('#modeCanvas').addEventListener('click', ()=> setMode('canvas'));
      $('#modeSettings').addEventListener('click', ()=> setMode('settings'));
      $('#themeBtn').addEventListener('click', toggleTheme);

      $('#sbNew')?.addEventListener('click', newDocument);
      $('#drawerNew')?.addEventListener('click', newDocument);
      $('#searchHistory')?.addEventListener('input', ()=> refreshHistoryUI());
      $('#sidebarSearch')?.addEventListener('input', ()=> refreshSidebarUI());

      window.addEventListener('keydown', e => {
        const meta = e.ctrlKey || e.metaKey;
        if (meta && e.key.toLowerCase()==='s'){ e.preventDefault(); saveDocument(); }
        if (meta && e.key.toLowerCase()==='p'){ e.preventDefault(); exportPDF(); }
      });
    }

    /*************** Settings ***************/
    function applySettingsToUI(){
      document.documentElement.style.setProperty('--mobile-side-pad', (state.settings.mobileSidePad || 12)+'px');
      document.documentElement.style.setProperty('--toolbar-gap', state.settings.density==='compact' ? '4px' : '6px');
    }
    function wireSettings(){
      const range = $('#setMobilePad'), num = $('#setMobilePadNumber');
      range.value = String(state.settings.mobileSidePad); num.value = String(state.settings.mobileSidePad);
      range.addEventListener('input', ()=>{ num.value=range.value; state.settings.mobileSidePad=Number(range.value); applySettingsToUI(); fitDoc(); });
      num.addEventListener('input', ()=>{ const v=clamp(Number(num.value)||12,8,28); range.value=String(v); state.settings.mobileSidePad=v; applySettingsToUI(); fitDoc(); });
      $('#densityCozy').addEventListener('click', ()=>{ state.settings.density='cozy'; applySettingsToUI(); });
      $('#densityCompact').addEventListener('click', ()=>{ state.settings.density='compact'; applySettingsToUI(); });
      $('#settingsApply').addEventListener('click', ()=>{ store.saveSettings(state.settings); flash('Settings saved'); });
      $('#settingsBack').addEventListener('click', ()=> setMode('doc'));
    }

    /*************** Boot ***************/
    function boot(){
      applyTheme(store.loadTheme() || 'dark');
      applySettingsToUI();

      // Each step isolated so one failure doesnâ€™t kill the UI
      try { initQuill(); } catch(e){ console.error(e); flash('Editor failed to load â€” check console'); }
      try { initCanvas(); } catch(e){ console.error(e); flash('Canvas failed to load â€” check console'); }

      wireMenus(); wireSettings();
      setMode('doc'); refreshHistoryUI(); refreshSidebarUI(); fitDoc();

      // autosave on blur / interval
      window.addEventListener('beforeunload', ()=>{ if (state.dirty) try{ store.upsert(getSnapshot()); }catch{} });
      setInterval(()=>{ if (state.dirty) saveDocument(); }, 30000);

      // Title edits mark dirty
      $('#docTitle').addEventListener('input', markDirty);

      window.addEventListener('resize', ()=> requestAnimationFrame(fitDoc));
    }

    document.addEventListener('DOMContentLoaded', boot);
  </script>
</body>
</html>
