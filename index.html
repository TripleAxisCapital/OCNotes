<!DOCTYPE html>
<html lang="en" class="h-full" data-theme="dark">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>OC Notes â€” Hybrid Word Ã— Obsidian (Single-File)</title>
  <meta name="description" content="Apple-style hybrid note app: rich document editor (Letter page) + freeform canvas with drawing. Export DOCX/PDF/HTML. Recent history. Dark/Light." />
  <meta name="theme-color" content="#0b0b0b" media="(prefers-color-scheme: dark)">
  <meta name="theme-color" content="#f5f5f7" media="(prefers-color-scheme: light)">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <link rel="manifest" href="manifest.webmanifest" crossorigin="use-credentials">

  <!-- TailwindCSS (CDN) -->
  <script> window.tailwind = { config: { darkMode: 'class' } } </script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          colors: { oc: { accent: '#3B82F6' } },
          borderRadius: { '2.5xl': '1.25rem' },
          boxShadow: {
            glass: '0 1px 0 rgba(255,255,255,0.06) inset, 0 20px 60px rgba(0,0,0,0.35)',
            paper: '0 10px 30px rgba(0,0,0,0.18)'
          },
          fontFamily: {
            system: [
              'ui-sans-serif','SF Pro Text','-apple-system','BlinkMacSystemFont',
              'Segoe UI','Roboto','Helvetica Neue','Arial','Noto Sans',
              'Apple Color Emoji','Segoe UI Emoji','Segoe UI Symbol'
            ]
          }
        }
      }
    }
  </script>

  <!-- Quill (rich text) -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/quill@1.3.7/dist/quill.snow.css" />
  <script src="https://cdn.jsdelivr.net/npm/quill@1.3.7/dist/quill.min.js"></script>

  <!-- Fabric.js (canvas) -->
  <script src="https://cdn.jsdelivr.net/npm/fabric@5.3.0/dist/fabric.min.js"></script>

  <!-- Export libs -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html-docx-js/0.4.1/html-docx.js"></script>

  <style>
    /* ======== THEME & TOKENS ======== */
    :root {
      --bg:#0b0b0b; --text:#ededed; --muted:rgba(255,255,255,0.7);
      --panel:rgba(255,255,255,0.06); --panel-2:rgba(255,255,255,0.04);
      --line:rgba(255,255,255,0.12); --accent:#3B82F6;
      --shadow-paper:0 10px 30px rgba(0,0,0,0.18);
      --paper:#111214; --paper-text:#f2f2f2; --paper-edge:rgba(255,255,255,0.06);
      --toolbar-gap: 6px;
      --mobile-side-pad: 12px; /* default; user-adjustable via Settings */
      --pagewrap-pad: 16px;    /* desktop default; overridden on mobile to var(--mobile-side-pad) */
    }
    html[data-theme="light"]{
      --bg:#f5f5f7; --text:#0a0a0a; --muted:rgba(0,0,0,0.65);
      --panel:rgba(255,255,255,0.9); --panel-2:rgba(255,255,255,0.85);
      --line:rgba(0,0,0,0.08); --accent:#0A84FF;
      --paper:#ffffff; --paper-text:#0a0a0a; --paper-edge:rgba(0,0,0,0.08);
    }

    html,body{height:100%; overflow-x:hidden}
    body{
      background:var(--bg); color:var(--text);
      overscroll-behavior-x: none;
      font-family:ui-sans-serif, SF Pro Text, -apple-system, BlinkMacSystemFont, Segoe UI, Roboto, Helvetica Neue, Arial, Noto Sans, Apple Color Emoji, Segoe UI Emoji, Segoe UI Symbol;
      -webkit-font-smoothing: antialiased; text-rendering: optimizeLegibility;
    }

    /* ======== GLASS + BACKGROUNDS ======== */
    .glass{background:var(--panel); backdrop-filter:blur(12px)}
    .glass-2{background:var(--panel-2); backdrop-filter:blur(12px)}
    .grad-bg{
      background:
        radial-gradient(1200px 600px at 20% 10%, rgba(99,102,241,0.20), transparent 60%),
        radial-gradient(1200px 800px at 80% 20%, rgba(56,189,248,0.15), transparent 60%),
        radial-gradient(1000px 1000px at 50% 100%, rgba(236,72,153,0.10), transparent 60%);
      animation:breathe 12s ease-in-out infinite;
    }
    @keyframes breathe{0%,100%{filter:saturate(100%) brightness(100%)}50%{filter:saturate(120%) brightness(112%)}}
    ::-webkit-scrollbar{width:10px;height:10px}
    ::-webkit-scrollbar-thumb{background:var(--line);border-radius:999px}
    ::-webkit-scrollbar-track{background:var(--panel-2)}

    /* ======== QUILL POLISH ======== */
    .ql-toolbar.ql-snow{
      border:1px solid var(--line);background:var(--panel-2);color:var(--text);
      position:relative; z-index:60; overflow:visible;
    }
    .ql-toolbar .ql-picker,.ql-toolbar button{color:var(--text)}
    .ql-snow .ql-stroke{stroke:var(--text)} .ql-snow .ql-fill{fill:var(--text)}
    .ql-container.ql-snow{border:1px solid var(--line);background:transparent;color:var(--text)}
    .ql-editor{color:var(--paper-text)}
    html[data-theme="dark"] ::selection{ background: rgba(59,130,246,0.35); color: inherit }
    html[data-theme="light"] ::selection{ background: rgba(10,132,255,0.28); color: inherit }
    html[data-theme="dark"] .ql-editor ::selection{ background: rgba(59,130,246,0.35) }
    html[data-theme="light"] .ql-editor ::selection{ background: rgba(10,132,255,0.28) }

    /* ======== PAGE AREA ======== */
    #pageWrap{
      display:flex; justify-content:center; align-items:flex-start; padding:var(--pagewrap-pad); overflow-x:hidden; width:100%;
      background:linear-gradient(var(--bg),var(--bg)) padding-box,
                 radial-gradient(600px 200px at 50% -50px, rgba(255,255,255,0.08), transparent) border-box;
    }
    #page{
      width:816px; min-height:1056px; background:var(--paper);
      border:1px solid var(--paper-edge); border-radius:12px; box-shadow:var(--shadow-paper);
      overflow:visible; position:relative; transform-origin: top center; margin:0 auto;
    }
    #page .ql-editor{min-height:calc(1056px - 2in); padding:1in; font-size:16px; line-height:1.6}

    /* ======== TITLES / PANELS ======== */
    .title-pill{ display:inline-flex; align-items:center; border-radius:9999px; max-width:100% }
    #docTitle{ width:auto; max-width:60ch }
    #canvasHost{min-height:calc(100vh - 260px); background:var(--panel); border-radius: 1rem}

    input[type=number]::-webkit-outer-spin-button,input[type=number]::-webkit-inner-spin-button{ -webkit-appearance:none; margin:0}
    input[type=number]{-moz-appearance:textfield; appearance:textfield}
    .z-topbar{z-index:70}.z-menu{z-index:90}.z-drawer{z-index:80}.z-pop{z-index:1000}

    /* Active tool */
    .tool-active{
      background: linear-gradient(135deg, #22d3ee 0%, #10b981 50%, #22d3ee 100%) !important;
      background-size: 200% 200%;
      color: #fff !important;
      animation: ocGradientShift 6s ease-in-out infinite;
      box-shadow: 0 0 0 1px rgba(255,255,255,0.18) inset, 0 6px 18px rgba(34,211,238,0.25);
      border-color: rgba(255,255,255,0.25) !important;
    }

    /* ======== RESPONSIVE TOOLBAR SHELLS ======== */
    /* Top actions container (desktop) */
    .top-actions{
      display:flex; flex-wrap:wrap; align-items:center; justify-content:flex-end; gap:8px;
    }
    /* All app toolbars use a common shell that never overlaps and scrolls horizontally when needed */
    .toolbar-shell{
      display:flex; align-items:center; gap:var(--toolbar-gap);
      flex-wrap:nowrap; overflow-x:auto; -webkit-overflow-scrolling:touch;
      scrollbar-gutter: stable both-edges;
    }
    .toolbar-shell > *{ flex-shrink:0; white-space:nowrap }
    /* Quill toolbar inner rail */
    #quillToolbar > .toolbar-shell{ padding:8px; }

    /* Canvas toolbars */
    .canvas-toolbar{ overflow-x:auto; -webkit-overflow-scrolling:touch; flex-wrap:nowrap; white-space:nowrap; max-width:100% }
    .canvas-toolbar > *{ flex-shrink:0 }
    .canvas-fs-toolbar{ max-width: min(100vw - 16px, 1200px); overflow-x:auto; -webkit-overflow-scrolling:touch }

    /* Keep dropdowns within viewport */
    .ql-snow .ql-picker-options{ max-height:60vh; overflow:auto }
    @media (max-width: 768px){ .ql-snow .ql-picker-options{ max-width:90vw; right:0 !important; left:auto !important } }

    /* ======== FULLSCREEN CANVAS ======== */
    body.fs-canvas-on{ overflow:hidden }
    body.fs-canvas-on header,
    body.fs-canvas-on #sidebarDock,
    body.fs-canvas-on section:nth-of-type(1),
    body.fs-canvas-on .mobile-bar{ display:none !important }
    body.fs-canvas-on main{ max-width:100vw; padding:0 !important; margin:0 }
    body.fs-canvas-on #canvasPanel{ display:block !important; margin-top:0 }
    body.fs-canvas-on #canvasHost{ position:fixed; inset:0; border-radius:0 }
    .canvas-fs-exit{ position:absolute; top:12px; right:12px; display:none; z-index:1001 }
    body.fs-canvas-on .canvas-fs-exit, body.fs-active .canvas-fs-exit{ display:inline-flex }
    .canvas-fs-toolbar{ position:absolute; top:calc(env(safe-area-inset-top, 0px) + 12px); left:50%; transform: translateX(-50%); display:flex; z-index:1002 }
    body.fs-canvas-on .canvas-toolbar, body.fs-active .canvas-toolbar{ display:none !important }
    #canvasHost canvas{ touch-action: none }
    .canvas-fs-toolbar button, .canvas-fs-toolbar input{ touch-action: manipulation }

    /* ======== PRINT ======== */
    @media print{
      body, html{ background:#fff; color:#000 }
      header, #canvasPanel, #historyDrawer, .mobile-bar{ display:none !important }
      main{ margin:0; padding:0 }
      #pageWrap{ background:#fff; box-shadow:none; border:none; padding:0 }
      #page{ width:816px; min-height:1056px; border:none; box-shadow:none }
      #page .ql-editor{ padding:1in; color:#000 }
    }

    /* ======== SAFE AREAS / SIDEBAR ======== */
    .safe-pad-bottom{ padding-bottom: env(safe-area-inset-bottom) }
    @media (min-width: 1024px){
      body.with-sidebar{ padding-left: 300px }
      body.with-sidebar header{ margin-left: -300px; width: calc(100% + 300px) }
    }
    body.sidebar-collapsed #sidebarDock{ display:none !important }
    #sidebarDock{ width:300px; position:fixed; left:0; top:var(--topbar-h,64px); bottom:0; padding:12px; display:none }
    @media (min-width:1024px){ #sidebarDock{ display:block } }
    #sidebarPanel{ height:100%; display:flex; flex-direction:column }
    #sidebarList{ overflow:auto; overscroll-behavior:contain }
    .note-row{ cursor:pointer }
    .note-row:hover{ background-color: rgba(255,255,255,0.06) }
    .note-row.active{ outline:1px solid var(--line); background-color: rgba(255,255,255,0.08) }

    /* ======== FLARE DETAILS ======== */
    .plus-glow{
      display:inline-flex; align-items:center; justify-content:center; width:22px; height:22px; margin-right:8px;
      border-radius:999px; color:white; font-weight:700; font-size:14px;
      background: linear-gradient(135deg, #22d3ee 0%, #10b981 50%, #22d3ee 100%);
      background-size: 200% 200%;
      box-shadow: 0 0 0 1px rgba(255,255,255,0.08) inset, 0 0 24px rgba(16,185,129,0.35), 0 4px 16px rgba(34,211,238,0.25);
      animation: ocGradientShift 6s ease-in-out infinite;
    }
    .plus-glow svg{ width:14px; height:14px; display:block }
    .mobile-bar .plus-glow{ margin-right:0 }
    @keyframes ocGradientShift{ 0%{ background-position: 0% 50% } 50%{ background-position: 100% 50% } 100%{ background-position: 0% 50% } }

    /* ======== QUILL FONTS / SIZES ======== */
    .ql-snow .ql-picker.ql-font .ql-picker-label::before,
    .ql-snow .ql-picker.ql-font .ql-picker-item::before { content: attr(data-label); }
    .ql-font-system{ font-family: ui-sans-serif, SF Pro Text, -apple-system, BlinkMacSystemFont, Segoe UI, Roboto, Helvetica Neue, Arial, Noto Sans, Apple Color Emoji, Segoe UI Emoji, Segoe UI Symbol; }
    .ql-font-serif{ font-family: ui-serif, Georgia, Cambria, "Times New Roman", Times, serif; }
    .ql-font-mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace; }
    .ql-font-georgia{ font-family: Georgia, Cambria, "Times New Roman", Times, serif; }
    .ql-font-garamond{ font-family: Garamond, Baskerville, "Times New Roman", Times, serif; }
    .ql-size-12px{ font-size:12px; }
    .ql-size-14px{ font-size:14px; }
    .ql-size-16px{ font-size:16px; }
    .ql-size-18px{ font-size:18px; }
    .ql-size-24px{ font-size:24px; }
    .ql-size-32px{ font-size:32px; }
    .ql-size-48px{ font-size:48px; }

    /* ======== MENU PANEL (POPUP) ======== */
    .menu-panel{ backdrop-filter: blur(12px); background: var(--panel-2); border: 1px solid var(--line); box-shadow: 0 18px 50px rgba(0,0,0,0.35); border-radius: 12px; overflow: hidden; }
    .menu-item{ width:100%; text-align:left; padding:10px 12px; word-break:break-word; white-space:nowrap }
    .menu-item:hover{ background: rgba(255,255,255,0.10); }

    /* Toolbar control sizing */
    .ql-toolbar .ql-formats{ margin-right:6px }
    .ql-toolbar .ql-picker-label, .ql-toolbar button{ padding:4px 6px }
    .canvas-fs-toolbar button{ padding:4px 8px }
    .canvas-fs-toolbar input{ margin:0 2px }

    /* Document widgets (tables/invoices) */
    .doc-widget{ position:relative; border:1px solid var(--line); border-radius:12px; background:var(--panel-2); padding:8px; margin:12px 0; user-select:text; -webkit-user-select:text; max-width:100% }
    .doc-widget .drag-handle{ position:absolute; top:6px; left:6px; width:18px; height:18px; border-radius:6px; background:var(--panel); border:1px solid var(--line); display:grid; place-content:center; cursor:grab }
    .doc-widget .drag-handle::before{ content:'â‹®â‹®'; font-size:10px; color:var(--muted) }
    .doc-widget .resize-handle{ position:absolute; right:6px; bottom:6px; width:14px; height:14px; border-right:2px solid var(--line); border-bottom:2px solid var(--line); cursor:nwse-resize; opacity:0.8 }
    .doc-widget [contenteditable="true"]{ outline:none }
    .doc-grid{ display:grid; gap:0 }
    .doc-cell{ border:1px solid var(--line); padding:8px; min-height:28px }

    /* Accessibility */
    :focus-visible{ outline:2px solid var(--accent); outline-offset:2px }

    /* ======== MOBILE FINE-TUNING ======== */
    @media (max-width: 1024px){
      #page{ border-radius:10px }
      #page .ql-editor{ padding:24px }
      .mobile-bar{ display:flex !important }
    }
    @media (max-width: 768px){
      /* force main padding to 0; pageWrap will control side padding */
      main{ padding-left:0 !important; padding-right:0 !important }
      :root{ --pagewrap-pad: var(--mobile-side-pad) }
    }
  </style>
</head>
<body class="h-full selection:bg-white/20">

  <!-- ======= TOP BAR ======= -->
  <header class="sticky top-0 z-topbar">
    <div class="grad-bg">
      <div class="glass border-b" style="border-color: var(--line)">
        <div class="w-full flex items-center justify-between gap-3 px-4 py-2">
          <div class="flex items-center gap-3 min-w-0">
            <div class="w-8 h-8 rounded-xl bg-white/90 text-black grid place-content-center font-bold flex-shrink-0">OC</div>
            <div class="leading-tight truncate">
              <div class="text-white/95 truncate" style="color:var(--text)"><strong>OC Notes</strong></div>
              <div class="text-xs truncate" style="color:var(--muted)">Hybrid Word Ã— Obsidian â€” local, private</div>
            </div>
          </div>

          <div class="flex items-center gap-2 min-w-0">
            <!-- Mobile hamburger only -->
            <button id="menuBtn" class="lg:hidden px-3 py-2 glass-2 hover:bg-white/20 rounded-xl border text-sm flex-shrink-0" style="border-color:var(--line)" aria-label="Open history">â˜°</button>

            <!-- Desktop actions only -->
            <div class="hidden lg:flex items-center top-actions min-w-0">
              <button id="toggleSidebar" class="px-3 py-2 glass-2 hover:bg-white/20 rounded-xl border text-sm" style="border-color:var(--line)">History</button>
              <button id="newBtn"   class="px-3 py-2 glass-2 hover:bg-white/20 rounded-xl border text-sm flex items-center" style="border-color:var(--line)"><span class="plus-glow" aria-hidden="true"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round"><path d="M12 5v14M5 12h14"/></svg></span>New</button>
              <button id="openBtn"  class="px-3 py-2 glass-2 hover:bg-white/20 rounded-xl border text-sm" style="border-color:var(--line)">Openâ€¦</button>
              <button id="saveBtn"  class="px-3 py-2 glass-2 hover:bg-white/20 rounded-xl border text-sm" style="border-color:var(--line)">Save âŒ˜S</button>

              <!-- Export (fixed-position popup to avoid clipping/overlap) -->
              <div class="relative">
                <button id="exportBtn" class="px-3 py-2 glass-2 hover:bg-white/20 rounded-xl border text-sm" style="border-color:var(--line)" aria-haspopup="menu" aria-expanded="false">Export â–¼</button>
              </div>

              <!-- Mode toggle -->
              <div class="ml-2 flex items-center rounded-xl glass-2 border overflow-hidden" style="border-color:var(--line)">
                <button id="modeDoc" class="px-3 py-2 text-sm bg-white/10">Document</button>
                <button id="modeCanvas" class="px-3 py-2 text-sm hover:bg-white/10">Canvas</button>
                <button id="modeSettings" class="px-3 py-2 text-sm hover:bg-white/10">Settings</button>
              </div>

              <!-- Theme toggle -->
              <button id="themeBtn" title="Toggle Light/Dark" class="ml-2 px-3 py-2 glass-2 hover:bg-white/20 rounded-xl border text-sm" style="border-color:var(--line)">â˜€ï¸Ž/ðŸŒ™</button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </header>

  <!-- ======= SIDEBAR (Desktop) ======= -->
  <aside id="sidebarDock" class="px-3">
    <div id="sidebarPanel" class="glass rounded-2xl border p-3" style="border-color:var(--line)">
      <div class="flex items-center gap-2 mb-2">
        <button id="sbNew" class="px-3 py-2 glass-2 hover:bg-white/20 rounded-xl border text-sm flex items-center flex-shrink-0" style="border-color:var(--line)"><span class="plus-glow" aria-hidden="true"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round"><path d="M12 5v14M5 12h14"/></svg></span>New</button>
        <input id="sidebarSearch" placeholder="Search notesâ€¦" class="w-full glass-2 border rounded-xl px-3 py-2 outline-none" style="border-color:var(--line); color:var(--text)" />
      </div>
      <div id="sidebarList" class="space-y-2 pr-1"></div>
    </div>
  </aside>

  <!-- ======= TITLE ROW ======= -->
  <section class="max-w-[1200px] mx-auto px-4 mt-3">
    <div class="flex items-center gap-2">
      <div class="title-pill glass-2 border px-3 py-1.5 w-full md:w-auto" style="border-color:var(--line)">
        <input id="docTitle" class="bg-transparent outline-none text-lg md:text-xl font-semibold w-full" style="color:var(--text)" placeholder="Untitled note" />
      </div>
      <span id="dirtyDot" class="w-2.5 h-2.5 rounded-full bg-rose-400/80 hidden" title="Unsaved changes"></span>
    </div>
  </section>

  <!-- ======= MAIN PANELS ======= -->
  <main class="max-w-[1200px] mx-auto px-4 mt-2">
    <!-- Document Mode -->
    <div id="docPanel" class="space-y-3">
      <div id="quillToolbar" class="rounded-2xl toolbar-scroll">
        <div class="glass border rounded-2xl toolbar-shell" style="border-color:var(--line)">
          <!-- Toolbar contents injected by Quill init; shell ensures layout -->
        </div>
      </div>
      <div id="pageWrap" class="rounded-2xl glass border" style="border-color:var(--line)">
        <div id="page"><div id="quillEditor"></div></div>
      </div>
    </div>

    <!-- Canvas Mode -->
    <div id="canvasPanel" class="hidden">
      <!-- Canvas Toolbar -->
      <div id="canvasToolDock" class="canvas-toolbar glass rounded-2xl border p-2 flex items-center gap-2" style="border-color:var(--line)">
        <button class="tool" data-tool="select" title="V">Move</button>
        <button class="tool" data-tool="text"   title="T">Text</button>
        <button class="tool" data-tool="sticky" title="N">Sticky</button>
        <button class="tool" data-tool="draw"   title="P">Pen</button>
        <button class="tool" data-tool="erase"  title="âŒ«">Erase</button>

        <div class="ml-2 flex items-center gap-2">
          <label class="text-sm" style="color:var(--muted)">Brush</label>
          <input id="brushSize" type="range" min="1" max="24" value="3" />
        </div>

        <div class="ml-2 flex items-center gap-2">
          <label class="text-sm" style="color:var(--muted)">Color</label>
          <input id="brushColor" type="color" value="#ffffff" class="w-9 h-9 p-0 bg-transparent border rounded-lg" style="border-color:var(--line)" />
        </div>

        <!-- Grid + Snap -->
        <div class="ml-4 flex items-center gap-2">
          <label class="text-sm" style="color:var(--muted)">Grid</label>
          <input id="gridToggle" type="checkbox" />
          <label class="text-sm" style="color:var(--muted)">Snap</label>
          <input id="snapToggle" type="checkbox" />
          <label class="text-sm" style="color:var(--muted)">Size</label>
          <input id="gridSize" type="number" value="24" min="4" max="200" class="w-16 glass-2 border rounded-lg px-2 py-1 text-sm" style="border-color:var(--line)" />
        </div>

        <!-- Canvas BG (applied to host, not Fabric background â€” preserves eraser) -->
        <div class="ml-4 flex items-center gap-2">
          <label class="text-sm" style="color:var(--muted)">Canvas BG</label>
          <input id="canvasBg" type="color" value="#0f0f11" class="w-9 h-9 p-0 bg-transparent border rounded-lg" style="border-color:var(--line)" />
        </div>

        <div class="ml-auto flex items-center gap-2">
          <button id="zoomOut" class="px-3 py-1.5 glass-2 hover:bg-white/20 rounded-lg border text-sm" style="border-color:var(--line)">âˆ’</button>
          <input id="zoomLevel" type="number" class="w-16 glass-2 border rounded-lg px-2 py-1 text-sm" style="border-color:var(--line)" value="100" />%
          <button id="zoomIn" class="px-3 py-1.5 glass-2 hover:bg-white/20 rounded-lg border text-sm" style="border-color:var(--line)">+</button>
          <button id="centerCanvas" class="px-3 py-1.5 glass-2 hover:bg-white/20 rounded-lg border text-sm" style="border-color:var(--line)">Center</button>
          <button id="clearCanvas" class="px-3 py-1.5 glass-2 hover:bg-white/20 rounded-lg border text-sm" style="border-color:var(--line)">Clear</button>
        </div>
        <div class="basis-full text-xs opacity-70 mt-1" style="color:var(--muted)">
          Move tool to drag Â· Text tool to type Â· Space = pan Â· Wheel = zoom
        </div>
      </div>

      <!-- Canvas Surface -->
      <div id="canvasHost" class="glass rounded-2xl border mt-3 overflow-hidden" style="border-color:var(--line); position:relative">
        <div id="fsToolbar" class="canvas-fs-toolbar glass border rounded-xl px-2 py-1.5 flex items-center gap-1" style="border-color:var(--line)">
          <button id="fsToolbarExit" class="px-2 py-1 text-sm rounded-lg hover:bg-white/10 border" style="border-color:var(--line)">Full</button>
          <div class="h-5 w-px bg-white/10 mx-1"></div>
          <button class="px-2 py-1 text-sm rounded-lg hover:bg-white/10 border tool" style="border-color:var(--line)" data-tool="select">Move</button>
          <button class="px-2 py-1 text-sm rounded-lg hover:bg-white/10 border tool" style="border-color:var(--line)" data-tool="sticky">Sticky</button>
          <button class="px-2 py-1 text-sm rounded-lg hover:bg-white/10 border tool" style="border-color:var(--line)" data-tool="text">Text</button>
          <button class="px-2 py-1 text-sm rounded-lg hover:bg-white/10 border tool" style="border-color:var(--line)" data-tool="draw">Pen</button>
          <button class="px-2 py-1 text-sm rounded-lg hover:bg-white/10 border tool" style="border-color:var(--line)" data-tool="erase">Erase</button>
          <div class="h-5 w-px bg-white/10 mx-1"></div>
          <input id="fsColor" type="color" class="w-7 h-7 p-0 bg-transparent border rounded-lg" style="border-color:var(--line)" title="Text/Brush Color" />
          <input id="fsBrush" type="range" min="1" max="24" value="3" class="align-middle" title="Pen Thickness" style="width:90px" />
          <div class="h-5 w-px bg-white/10 mx-1"></div>
          <button id="fsUndo" class="px-2 py-1 text-sm rounded-lg hover:bg-white/10 border" style="border-color:var(--line)">Undo</button>
          <button id="fsRedo" class="px-2 py-1 text-sm rounded-lg hover:bg-white/10 border" style="border-color:var(--line)">Redo</button>
          <div class="h-5 w-px bg-white/10 mx-1"></div>
          <button id="fsInsertInvoice" class="px-2 py-1 text-sm rounded-lg hover:bg-white/10 border" style="border-color:var(--line)">Invoice</button>
        </div>
        <canvas id="ocCanvas"></canvas>
      </div>
    </div>

    <!-- Settings Mode -->
    <div id="settingsPanel" class="hidden">
      <div class="glass rounded-2xl border p-4 md:p-6" style="border-color:var(--line)">
        <h2 class="text-xl font-semibold mb-3" style="color:var(--text)">Settings</h2>
        <div class="grid md:grid-cols-2 gap-4">
          <div class="glass-2 border rounded-xl p-3" style="border-color:var(--line)">
            <div class="font-medium mb-2" style="color:var(--text)">Mobile document side padding</div>
            <div class="text-sm mb-3" style="color:var(--muted)">Controls the visual padding on either side of the document on small screens. Default: 12px.</div>
            <div class="flex items-center gap-2">
              <input id="setMobilePad" type="range" min="8" max="28" step="1" class="w-56" />
              <input id="setMobilePadNumber" type="number" min="8" max="28" step="1" class="w-16 glass-2 border rounded-lg px-2 py-1 text-sm" style="border-color:var(--line)" />
              <span class="text-sm" style="color:var(--muted)">px</span>
            </div>
          </div>

          <div class="glass-2 border rounded-xl p-3" style="border-color:var(--line)">
            <div class="font-medium mb-2" style="color:var(--text)">Interface density</div>
            <div class="text-sm mb-3" style="color:var(--muted)">Choose a toolbar density that fits your preference.</div>
            <div class="flex gap-2">
              <button id="densityCozy" class="px-3 py-2 glass-2 hover:bg-white/20 rounded-xl border text-sm" style="border-color:var(--line)">Cozy</button>
              <button id="densityCompact" class="px-3 py-2 glass-2 hover:bg-white/20 rounded-xl border text-sm" style="border-color:var(--line)">Compact</button>
            </div>
          </div>
        </div>

        <div class="mt-6 flex items-center justify-end gap-2">
          <button id="settingsBack" class="px-3 py-2 glass-2 hover:bg-white/20 rounded-xl border text-sm" style="border-color:var(--line)">Back</button>
          <button id="settingsApply" class="px-3 py-2 glass-2 hover:bg-white/20 rounded-xl border text-sm" style="border-color:var(--line)">Apply</button>
        </div>
      </div>
    </div>
  </main>

  <!-- ======= HISTORY DRAWER ======= -->
  <div id="historyDrawer" class="fixed inset-0 hidden z-drawer">
    <div class="absolute inset-0 bg-black/50" data-close-history></div>
    <div class="absolute left-0 top-0 h-full w-[360px] glass border-r p-4 overflow-y-auto" style="border-color:var(--line)">
      <div class="flex items-center justify-between mb-3">
        <h3 class="text-lg font-semibold" style="color:var(--text)">Workspaces</h3>
        <div class="flex items-center gap-2">
          <button id="drawerNew" class="w-9 h-9 grid place-content-center glass-2 hover:bg-white/20 rounded-lg border" style="border-color:var(--line)" title="New workspace" aria-label="New workspace"><span class="plus-glow" aria-hidden="true"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round"><path d="M12 5v14M5 12h14"/></svg></span></button>
          <button data-close-history class="px-3 py-1.5 glass-2 hover:bg-white/20 rounded-lg border text-sm" style="border-color:var(--line)">Close</button>
        </div>
      </div>
      <div class="mb-3">
        <input id="searchHistory" placeholder="Searchâ€¦" class="w-full glass-2 border rounded-xl px-3 py-2 outline-none" style="border-color:var(--line); color:var(--text)" />
      </div>
      <div id="historyList" class="space-y-2"></div>
      <div class="mt-4 pt-3 border-t" style="border-color:var(--line)">
        <div class="text-xs mb-2" style="color:var(--muted)">Export current</div>
        <div class="grid grid-cols-2 gap-2">
          <button class="px-3 py-2 glass-2 hover:bg-white/20 rounded-xl border text-sm" style="border-color:var(--line)" data-drawer-export="docx">DOCX</button>
          <button class="px-3 py-2 glass-2 hover:bg-white/20 rounded-xl border text-sm" style="border-color:var(--line)" data-drawer-export="pdf">PDF</button>
          <button class="px-3 py-2 glass-2 hover:bg-white/20 rounded-xl border text-sm" style="border-color:var(--line)" data-drawer-export="html">HTML</button>
          <button class="px-3 py-2 glass-2 hover:bg-white/20 rounded-xl border text-sm" style="border-color:var(--line)" data-drawer-export="json">Project</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Hidden file input -->
  <input id="openFile" type="file" accept=".ocnote,application/json" class="hidden" />

  <!-- Offscreen export staging (used by PDF if ever needed) -->
  <div id="exportStage" style="position:absolute; left:-9999px; top:0; width:816px; background:#fff; color:#000; padding:24px;"></div>

  <!-- Floating export menu (portal) -->
  <div id="exportMenu" class="hidden fixed z-pop menu-panel w-56"></div>

  <script>
    /* =============== UTILITIES =============== */
    const $  = (sel, el=document) => el.querySelector(sel);
    const $$ = (sel, el=document) => Array.from(el.querySelectorAll(sel));
    const uid = () => 'oc_' + Math.random().toString(36).slice(2) + Date.now().toString(36);
    const nowISO = () => new Date().toISOString();
    const clamp = (v, a, b) => Math.max(a, Math.min(b, v));
    const safeFileName = (name) => (name || 'note').replace(/[^a-z0-9\-]+/gi,'_');
    const escapeHtml = (str) => (str+'').replace(/[&<>"']/g, s=>({"&":"&amp;","<":"&lt;","&gt;":"&gt;","\"":"&quot;","'":"&#39;"}[s]));
    const niceDate = (iso) => { try { return new Date(iso).toLocaleString(); } catch { return iso; } }
    const isSafari = () => /^((?!chrome|android).)*safari/i.test(navigator.userAgent);
    const debounce = (fn, ms=300) => { let t; return (...args)=>{ clearTimeout(t); t=setTimeout(()=>fn(...args),ms) }; }

    function hexToRGBA(hex, a=1){
      try{
        let h = hex.replace('#','');
        if (h.length===3) h = h.split('').map(c=>c+c).join('');
        const n = parseInt(h,16); const r=(n>>16)&255, g=(n>>8)&255, b=n&255;
        return `rgba(${r},${g},${b},${a})`;
      }catch{ return `rgba(255,255,255,${a})`; }
    }

    function flash(msg) {
      const div = document.createElement('div');
      div.textContent = msg;
      div.className = 'fixed bottom-5 left-1/2 -translate-x-1/2 px-4 py-2 rounded-xl glass border text-white';
      div.style.borderColor = getComputedStyle(document.body).getPropertyValue('--line');
      document.body.appendChild(div);
      setTimeout(()=>div.remove(), 1300);
    }

    async function downloadBlob(blob, filename) {
      const a = document.createElement('a');
      const url = URL.createObjectURL(blob);
      const canDownload = 'download' in a && !isSafari();
      if (canDownload) {
        a.href = url; a.download = filename; document.body.appendChild(a); a.click(); a.remove();
        setTimeout(() => URL.revokeObjectURL(url), 4000);
      } else {
        try {
          const data = await blobToDataURL(blob);
          const win = window.open(data, '_blank');
          if (!win) location.href = data;
        } finally {
          setTimeout(() => URL.revokeObjectURL(url), 0);
        }
      }
    }
    const blobToDataURL = (blob) => new Promise((res, rej) => { const fr = new FileReader(); fr.onload = () => res(fr.result); fr.onerror = rej; fr.readAsDataURL(blob); });

    /* =============== PERSISTENCE =============== */
    const store = {
      key: 'oc_notes_history_v4',
      themeKey: 'oc_theme',
      sidebarKey: 'oc_sidebar_open',
      settingsKey: 'oc_settings_v1',
      loadAll() { try { return JSON.parse(localStorage.getItem(this.key)) || []; } catch { return []; } },
      saveAll(list) { localStorage.setItem(this.key, JSON.stringify(list)); },
      upsert(doc) {
        const list = this.loadAll();
        const idx = list.findIndex(x => x.id === doc.id);
        if (idx >= 0) list[idx] = doc; else list.unshift(doc);
        this.saveAll(list.slice(0,25));
      },
      saveTheme(v){ localStorage.setItem(this.themeKey, v); },
      loadTheme(){ return localStorage.getItem(this.themeKey); },
      saveSidebarOpen(v){ localStorage.setItem(this.sidebarKey, v ? '1':'0'); },
      loadSidebarOpen(){ return localStorage.getItem(this.sidebarKey) !== '0'; },
      loadSettings(){
        let s = {};
        try{ s = JSON.parse(localStorage.getItem(this.settingsKey)) || {}; } catch{}
        return Object.assign({ mobileSidePad: 12, density: 'cozy' }, s);
      },
      saveSettings(s){ localStorage.setItem(this.settingsKey, JSON.stringify(s)); }
    };

    /* =============== STATE =============== */
    const state = {
      id: uid(),
      mode: 'doc', // 'doc' | 'canvas' | 'settings'
      dirty: false,
      quill: null,
      canvas: null,
      hist: { stack: [], idx: -1 },
      suppressHistory: false,
      currentTool: 'select',
      awaitingPlacement: null,
      zoom: 1,
      isSpacePanning: false,
      grid: { show:false, snap:false, size:24, targetTol:10 },
      sidebarOpen: true,
      docScale: 1,
      settings: store.loadSettings()
    };
    const markDirty = () => { state.dirty = true; $('#dirtyDot').classList.remove('hidden'); try { autoSave && autoSave(); } catch {} }
    const clearDirty = () => { state.dirty = false; $('#dirtyDot').classList.add('hidden'); }

    /* =============== THEME =============== */
    function applyTheme(t) {
      document.documentElement.setAttribute('data-theme', t);
      if (t === 'dark') document.documentElement.classList.add('dark');
      else document.documentElement.classList.remove('dark');
      store.saveTheme(t);
      // update theme-color meta
      const metaTags = document.querySelectorAll('meta[name="theme-color"]');
      metaTags.forEach(m => {
        if (t==='dark' && m.media?.includes('dark')) m.setAttribute('content', '#0b0b0b');
        if (t==='light' && m.media?.includes('light')) m.setAttribute('content', '#f5f5f7');
      });
    }
    const toggleTheme = () => applyTheme((document.documentElement.getAttribute('data-theme') || 'dark') === 'dark' ? 'light' : 'dark');

    /* =============== SETTINGS APPLY =============== */
    function applySettingsToUI(){
      // Mobile side padding variable
      document.documentElement.style.setProperty('--mobile-side-pad', (state.settings.mobileSidePad || 12) + 'px');

      // Density: tweak toolbar padding globally
      const compact = state.settings.density === 'compact';
      document.documentElement.style.setProperty('--toolbar-gap', compact ? '4px':'6px');
      // Quill control sizing is already compact; we slightly reduce paddings:
      const qtl = $('.ql-toolbar'); if (qtl) qtl.style.setProperty('padding', compact ? '6px' : '8px');

      // Reflect in Settings form
      const range = $('#setMobilePad'); const num = $('#setMobilePadNumber');
      if (range) range.value = String(state.settings.mobileSidePad || 12);
      if (num)   num.value   = String(state.settings.mobileSidePad || 12);
    }

    /* =============== QUILL =============== */
    function renderQuillToolbar() {
      // Insert Apple-clean toolbar controls into existing shell
      const shell = $('#quillToolbar .toolbar-shell');
      shell.innerHTML = `
        <span class="ql-formats">
          <select class="ql-font">
            <option selected value="system" data-label="System">System</option>
            <option value="serif" data-label="Serif">Serif</option>
            <option value="mono" data-label="Mono">Mono</option>
            <option value="georgia" data-label="Georgia">Georgia</option>
            <option value="garamond" data-label="Garamond">Garamond</option>
          </select>
        </span>
        <span class="ql-formats">
          <select class="ql-header"><option selected></option><option value="1">H1</option><option value="2">H2</option><option value="3">H3</option></select>
        </span>
        <span class="ql-formats">
          <button class="ql-bold"></button><button class="ql-italic"></button>
          <button class="ql-underline"></button><button class="ql-strike"></button>
        </span>
        <span class="ql-formats">
          <button class="ql-list" value="ordered"></button><button class="ql-list" value="bullet"></button>
        </span>
        <span class="ql-formats"><select class="ql-align"></select></span>
        <span class="ql-formats"><button class="ql-link"></button><button class="ql-image"></button><button class="ql-code-block"></button></span>
        <span class="ql-formats"><button class="ql-indent" value="-1"></button><button class="ql-indent" value="+1"></button></span>
        <span class="ql-formats"><select class="ql-color"></select><select class="ql-background"></select></span>
        <span class="ql-formats">
          <select class="ql-size">
            <option value="12px">12</option>
            <option value="14px">14</option>
            <option selected value="16px">16</option>
            <option value="18px">18</option>
            <option value="24px">24</option>
            <option value="32px">32</option>
            <option value="48px">48</option>
          </select>
        </span>
        <span class="ql-formats"><button class="ql-clean"></button></span>
        <span class="ql-formats">
          <button id="docInsertInvoice" class="px-2 py-1 text-sm rounded-lg hover:bg-white/10 border" style="border-color:var(--line)">Invoice</button>
        </span>
      `;
    }
    function initQuill() {
      renderQuillToolbar();
      const Font = Quill.import('attributors/class/font');
      Font.whitelist = ['system','serif','mono','georgia','garamond'];
      Quill.register(Font, true);
      const Size = Quill.import('attributors/class/size');
      Size.whitelist = ['12px','14px','16px','18px','24px','32px','48px'];
      Quill.register(Size, true);

      const q = new Quill('#quillEditor', { theme:'snow', modules:{ toolbar:'#quillToolbar .toolbar-shell' } });
      state.quill = q;
      q.on('text-change', markDirty);

      $('#docInsertInvoice')?.addEventListener('click', () => insertInvoiceDoc());

      function insertInvoiceDoc(){
        const col = ($('#brushColor')?.value) || '#3B82F6';
        const border = hexToRGBA(col, 0.35);
        const header = `<div style=\"text-align:center; font-weight:700; font-size:22px; margin-bottom:8px; color:${col}\">INVOICE</div>`;
        const parties = `<div style=\"display:grid; grid-template-columns:1fr 1fr; gap:12px; margin-bottom:12px; color:${col}\"><div contenteditable=\"true\">From:<br>Your Company<br>Address</div><div contenteditable=\"true\">Bill To:<br>Client Name<br>Address</div></div>`;
        const thCell = `class=\\"doc-cell\\" style=\\"font-weight:600; border:1px solid ${border}; color:${col}\\"`;
        const tdCell = `class=\\"doc-cell\\" style=\\"border:1px solid ${border}; color:${col}\\" contenteditable=\\"true\\"`;
        const tableHead = `<div style=\"display:grid; grid-template-columns: 2fr 1fr 1fr 1fr;\"><div ${thCell}>Item</div><div ${thCell}>Qty</div><div ${thCell}>Price</div><div ${thCell}>Amount</div></div>`;
        const rows = Array.from({length:4}).map(()=>`<div style=\"display:grid; grid-template-columns:2fr 1fr 1fr 1fr;\"><div ${tdCell}><br></div><div ${tdCell}><br></div><div ${tdCell}><br></div><div ${tdCell}><br></div></div>`).join('');
        const totals = `<div style=\"display:grid; grid-template-columns: 2fr 1fr 1fr; gap:12px; align-items:center; margin-top:12px\"><div class=\"doc-cell\" style=\"border:1px solid ${border}; color:${col}\" contenteditable=\"true\">Notes</div><div style=\"text-align:right; font-weight:600; color:${col}\">Total:</div><div class=\"doc-cell\" style=\"border:1px solid ${border}; color:${col}\" contenteditable=\"true\">$0.00</div></div>`;
        const body = `<div>${header}${parties}<div class=\"doc-grid\">${tableHead}${rows}</div>${totals}</div>`;
        const html = `<div class=\"doc-widget\" style=\"border-color:${border}; color:${col}\" contenteditable=\"false\" draggable=\"true\" data-type=\"invoice\"><div class=\"drag-handle\" title=\"Drag\"></div><div class=\"resize-handle\" title=\"Resize\"></div>${body}</div>`;
        q.clipboard.dangerouslyPasteHTML(q.getSelection()?.index ?? q.getLength(), html);
        markDirty();
      }

      // Doc widget interactions (drag/resize)
      (function wireDocWidgets(){
        const root = q.root;
        let dragEl = null;
        root.addEventListener('dragstart', (e) => {
          const w = e.target.closest('.doc-widget');
          if (!w) { e.preventDefault(); return; }
          dragEl = w; w.style.opacity = '0.5';
          e.dataTransfer.effectAllowed = 'move';
          e.dataTransfer.setData('text/plain', 'doc-widget');
        });
        root.addEventListener('dragend', () => { if (dragEl) dragEl.style.opacity=''; dragEl=null; });
        root.addEventListener('dragover', (e) => { if (dragEl) e.preventDefault(); });
        root.addEventListener('drop', (e) => {
          if (!dragEl) return; e.preventDefault();
          const target = e.target.closest('.doc-widget');
          const parent = root;
          if (target && target !== dragEl) {
            const rect = target.getBoundingClientRect();
            if (e.clientY < rect.top + rect.height/2) parent.insertBefore(dragEl, target);
            else parent.insertBefore(dragEl, target.nextSibling);
          }
          dragEl.style.opacity=''; dragEl=null; markDirty();
        });

        // Resize handle
        let rs = { el:null, startX:0, startW:0 };
        root.addEventListener('pointerdown', (e) => {
          if (!e.target.classList.contains('resize-handle')) return;
          const w = e.target.closest('.doc-widget'); if (!w) return;
          rs.el = w; rs.startX = e.clientX; rs.startW = w.offsetWidth;
          e.preventDefault(); e.target.setPointerCapture && e.target.setPointerCapture(e.pointerId);
        });
        root.addEventListener('pointermove', (e) => {
          if (!rs.el) return;
          const dx = (e.clientX - rs.startX);
          const maxW = root.clientWidth - 16; const minW = 200;
          const newW = Math.max(minW, Math.min(maxW, rs.startW + dx));
          rs.el.style.width = newW + 'px';
        });
        root.addEventListener('pointerup', () => { if (rs.el) { rs.el=null; markDirty(); } });
        root.addEventListener('pointercancel', () => { rs.el=null; });
        root.addEventListener('input', (e) => { if (e.target.closest('.doc-widget')) markDirty(); });
      })();
    }

    /* =============== FABRIC CANVAS (with robust Eraser) =============== */
    function initCanvas() {
      const host = $('#canvasHost');
      const cEl = $('#ocCanvas');
      const canvas = new fabric.Canvas(cEl, {
        backgroundColor: null,               // keep transparent; host provides BG (eraser-safe)
        selection: true,
        preserveObjectStacking: true,
        perPixelTargetFind: true,
        targetFindTolerance: state.grid.targetTol
      });
      state.canvas = canvas;
      try { canvas.upperCanvasEl.setAttribute('tabindex','1'); } catch {}

      // History helpers
      const SAVE_PROPS = ['selectable','evented','stroke','strokeWidth','fill','fontSize','backgroundColor','padding','rx','ry','strokeUniform','globalCompositeOperation','eraser'];
      function pushHistory(){
        if (!canvas || state.suppressHistory) return;
        try {
          const snap = { json: canvas.toJSON(SAVE_PROPS) };
          state.hist.stack = state.hist.stack.slice(0, state.hist.idx + 1);
          state.hist.stack.push(snap);
          state.hist.idx = state.hist.stack.length - 1;
        } catch {}
      }
      const pushHistoryDebounced = debounce(pushHistory, 250);
      canvas.__pushHistoryDebounced = pushHistoryDebounced;

      async function loadHistoryAt(idx){
        if (idx < 0 || idx >= state.hist.stack.length) return;
        const snap = state.hist.stack[idx];
        state.suppressHistory = true;
        try {
          await new Promise(res => canvas.loadFromJSON(snap.json, () => res()));
          canvas.requestRenderAll();
        } finally {
          state.suppressHistory = false;
        }
      }
      const undoCanvas = async () => { if (state.hist.idx > 0) { state.hist.idx--; await loadHistoryAt(state.hist.idx); } }
      const redoCanvas = async () => { if (state.hist.idx < state.hist.stack.length - 1) { state.hist.idx++; await loadHistoryAt(state.hist.idx); } }

      // size
      const resize = () => {
        const vv = window.visualViewport;
        const vw = (vv?.width) ? Math.round(vv.width) : (host.clientWidth || window.innerWidth || 1200);
        const fsOn = document.body.classList.contains('fs-canvas-on');
        const vh = (vv?.height) ? Math.round(vv.height) : window.innerHeight;
        const h = fsOn ? vh : Math.max(600, window.innerHeight - 260);
        cEl.width = vw; cEl.height = h;
        canvas.setWidth(vw); canvas.setHeight(h);
        canvas.requestRenderAll();
      };
      resize();
      window.addEventListener('resize', debounce(resize, 120));
      if (window.visualViewport){
        visualViewport.addEventListener('resize', debounce(resize, 60));
        visualViewport.addEventListener('scroll', debounce(resize, 60));
      }

      // drawing defaults
      canvas.isDrawingMode = false;
      canvas.freeDrawingBrush.width = 3;
      canvas.freeDrawingBrush.color = '#ffffff';

      // Strong eraser support:
      // 1) If fabric.EraserBrush exists: use it.
      // 2) Else: use PencilBrush but set the created path's globalCompositeOperation to 'destination-out' so it truly erases pixels.
      function setEraseBrush(){
        canvas.isDrawingMode = true;
        if (fabric.EraserBrush) {
          canvas.freeDrawingBrush = new fabric.EraserBrush(canvas);
          canvas.freeDrawingBrush.width = Number($('#brushSize').value || 12);
        } else {
          canvas.freeDrawingBrush = new fabric.PencilBrush(canvas);
          canvas.freeDrawingBrush.width = Number($('#brushSize').value || 12);
          canvas.freeDrawingBrush.color = 'rgba(0,0,0,1)';
        }
        canvas.defaultCursor = 'crosshair';
      }

      // Path handling
      canvas.on('path:created', (e) => {
        const p = e.path;
        const isErase = (state.currentTool === 'erase');
        if (isErase) {
          // If EraserBrush exists, Fabric already did the right thing. Otherwise, make this path an eraser via gCO.
          if (!fabric.EraserBrush) {
            p.globalCompositeOperation = 'destination-out';
            p.stroke = 'rgba(0,0,0,1)';
            p.fill = null;
            p.selectable = false; p.evented = false;
            p.strokeUniform = true;
          }
          // keep the path so the erase effect persists / exports
          markDirty(); pushHistoryDebounced();
          return;
        }
        // Normal draw path polish
        p.set({
          selectable:true, evented:true, hasControls:true, hasBorders:true,
          hoverCursor:'move', fill:null, strokeUniform:true, erasable:true
        });
        p.set({ stroke: $('#brushColor').value || '#ffffff', strokeWidth: Number($('#brushSize').value || 3) });
        markDirty(); pushHistoryDebounced();
      });

      // Interaction model
      canvas.on('mouse:down', (opt) => {
        try { if (document.activeElement && document.activeElement !== document.body) document.activeElement.blur(); } catch {}
        const target = opt.target;
        const pt = canvas.getPointer(opt.e);

        // Space-pan start
        if (state.isSpacePanning) {
          canvas.isDragging = true;
          canvas.selection = false;
          canvas.lastPosX = opt.e.clientX;
          canvas.lastPosY = opt.e.clientY;
          return;
        }

        // Move tool quick tap edit
        if (state.currentTool === 'select' && target && (target.type === 'textbox' || target.type === 'i-text')) {
          const isTouch = !!(opt.e && (opt.e.touches || opt.e.pointerType === 'touch'));
          if (isTouch) {
            if (!target.isEditing) {
              canvas.setActiveObject(target);
              target.enterEditing();
              target.hiddenTextarea && target.hiddenTextarea.focus();
              const len = target.text?.length ?? 0;
              target.setSelectionStart(len); target.setSelectionEnd(len);
            }
            return;
          }
        }

        // Text placement
        if (state.currentTool === 'text') {
          if (target && target.type === 'textbox') {
            if (!target.isEditing) {
              canvas.setActiveObject(target);
              target.enterEditing();
              target.hiddenTextarea && target.hiddenTextarea.focus();
              const len = target.text?.length ?? 0;
              target.setSelectionStart(len); target.setSelectionEnd(len);
            }
            return;
          }
          const tb = new fabric.Textbox('',
            { left: pt.x, top: pt.y, width: 320, fontSize: 20, editable: true,
              fill: $('#brushColor').value || '#ffffff',
              backgroundColor: 'rgba(255,255,255,0.04)', padding: 8, cornerStyle:'circle',
              erasable: true
            });
          canvas.add(tb);
          canvas.setActiveObject(tb);
          tb.enterEditing(); tb.hiddenTextarea && tb.hiddenTextarea.focus();
          canvas.requestRenderAll(); markDirty(); pushHistoryDebounced();
          return;
        }

        // Sticky placement
        if (state.currentTool === 'sticky') {
          const sticky = new fabric.Textbox('',
            { left: pt.x, top: pt.y, width: 260, fontSize: 18, editable: true,
              fill:'#1f2937', backgroundColor: '#facc15', padding: 10, rx: 12, ry: 12, cornerStyle:'circle',
              erasable: true
            });
          canvas.add(sticky);
          canvas.setActiveObject(sticky);
          useTool('text');
          sticky.enterEditing(); sticky.hiddenTextarea && sticky.hiddenTextarea.focus();
          canvas.requestRenderAll(); markDirty(); pushHistoryDebounced();
          return;
        }
      });

      canvas.on('text:changed', () => { markDirty(); pushHistoryDebounced(); });

      // Space-pan move/end
      canvas.on('mouse:move', (opt) => {
        if (canvas.isDragging) {
          const v = canvas.viewportTransform;
          v[4] += opt.e.clientX - canvas.lastPosX;
          v[5] += opt.e.clientY - canvas.lastPosY;
          canvas.requestRenderAll();
          canvas.lastPosX = opt.e.clientX; canvas.lastPosY = opt.e.clientY;
        }
      });
      canvas.on('mouse:up', () => {
        canvas.isDragging = false;
        canvas.selection = (state.currentTool === 'select');
      });

      // snap-to-grid
      function maybeSnap(target) {
        if (!state.grid.snap) return;
        const gs = state.grid.size;
        target.set({
          left: Math.round(target.left / gs) * gs,
          top:  Math.round(target.top  / gs) * gs
        });
      }
      canvas.on('object:moving', (e) => { maybeSnap(e.target); });
      canvas.on('object:scaling', (e) => { maybeSnap(e.target); });

      // grid overlay
      canvas.on('after:render', () => {
        if (!state.grid.show) return;
        const ctx = canvas.getContext();
        const vpt = canvas.viewportTransform;
        const zoom = canvas.getZoom();
        const gs = state.grid.size * zoom;
        const xStart = -vpt[4] % gs;
        const yStart = -vpt[5] % gs;
        ctx.save();
        ctx.strokeStyle = 'rgba(255,255,255,0.08)';
        ctx.lineWidth = 1;
        for (let x = xStart; x < canvas.getWidth(); x += gs) { ctx.beginPath(); ctx.moveTo(x,0); ctx.lineTo(x,canvas.getHeight()); ctx.stroke(); }
        for (let y = yStart; y < canvas.getHeight(); y += gs) { ctx.beginPath(); ctx.moveTo(0,y); ctx.lineTo(canvas.getWidth(),y); ctx.stroke(); }
        ctx.restore();
      });

      // wheel zoom
      canvas.on('mouse:wheel', (opt) => {
        const delta = opt.e.deltaY;
        let zoom = state.zoom * (delta > 0 ? 0.95 : 1.05);
        zoom = clamp(zoom, 0.1, 5);
        const point = new fabric.Point(opt.e.offsetX, opt.e.offsetY);
        canvas.zoomToPoint(point, zoom);
        state.zoom = zoom;
        $('#zoomLevel').value = Math.round(zoom * 100);
        opt.e.preventDefault(); opt.e.stopPropagation();
      });

      // keys
      function isEditingCanvasText(){
        try{
          const obj = canvas.getActiveObject && canvas.getActiveObject();
          return !!(obj && (obj.isEditing === true || obj.isEditing));
        } catch { return false; }
      }
      canvas.on('mouse:dblclick', (opt) => {
        const t = opt.target;
        if (t && (t.type === 'textbox' || t.type === 'i-text')) {
          canvas.setActiveObject(t);
          t.enterEditing();
          t.hiddenTextarea && t.hiddenTextarea.focus();
        }
      });
      window.addEventListener('keydown', (e) => {
        if (state.mode !== 'canvas') return;
        if (isEditingCanvasText()) return;
        const isMeta = e.ctrlKey || e.metaKey;
        if (isMeta && e.key.toLowerCase() === 'z') { e.preventDefault(); return e.shiftKey ? redoCanvas() : undoCanvas(); }
        const k = e.key.toLowerCase();
        if (k === 'v') useTool('select');
        if (k === 'p') useTool('draw');
        if (k === 't') useTool('text');
        if (k === 'n') useTool('sticky');
        if (e.code === 'Space' && !state.isSpacePanning) {
          state.isSpacePanning = true; canvas.defaultCursor = 'grab'; canvas.selection = false;
        }
        if ((e.key === 'Delete' || e.key === 'Backspace')) {
          const active = canvas.getActiveObjects();
          if (active.length) {
            active.forEach(o => canvas.remove(o));
            canvas.discardActiveObject();
            canvas.requestRenderAll();
            markDirty(); pushHistoryDebounced();
          }
        }
      });
      window.addEventListener('keyup', (e) => {
        if (e.code === 'Space') {
          state.isSpacePanning = false;
          canvas.defaultCursor = (state.currentTool === 'draw' || state.currentTool === 'erase') ? 'crosshair' : 'default';
          canvas.selection = (state.currentTool === 'select');
        }
      });

      // mark dirty on object changes
      canvas.on('object:added', () => { markDirty(); pushHistoryDebounced(); });
      canvas.on('object:modified', () => { markDirty(); pushHistoryDebounced(); });
      canvas.on('object:removed', () => { markDirty(); pushHistoryDebounced(); });

      // Tool buttons
      const toolBtns = $$('#canvasPanel .tool');
      const fsToolBtns = $$('#fsToolbar [data-tool]');
      toolBtns.forEach(btn => {
        btn.classList.add('px-3','py-1.5','glass-2','hover:bg-white/20','rounded-lg','border','text-sm');
        btn.style.borderColor = getComputedStyle(document.body).getPropertyValue('--line');
        btn.addEventListener('click', () => useTool(btn.dataset.tool));
      });
      const setToolActive = (tool) => {
        toolBtns.forEach(b => b.classList.toggle('tool-active', b.dataset.tool === tool));
        fsToolBtns.forEach(b => b.classList.toggle('tool-active', b.dataset.tool === tool));
      };
      fsToolBtns.forEach(btn => btn.addEventListener('click', () => useTool(btn.dataset.tool)));
      $('#fsUndo')?.addEventListener('click', undoCanvas);
      $('#fsRedo')?.addEventListener('click', redoCanvas);
      $('#fsInsertInvoice')?.addEventListener('click', () => insertInvoice());

      function insertInvoice(){
        const items = [];
        const cx = canvas.getWidth()/2; let y = Math.max(40, canvas.getHeight()*0.1);
        const mkText = (txt, opts={}) => new fabric.Textbox(txt, Object.assign({ left: cx-200, top: y, width: 400, fontSize: 20, fill: '#ffffff', textAlign:'center', erasable:true }, opts));
        const title = mkText('INVOICE', { fontSize: 28, fontWeight: '700' }); y += 40;
        const from = new fabric.Textbox('From:\\nYour Company\\nAddress', { left: cx-360, top: y, width: 240, fontSize: 14, fill:'#ffffff', erasable:true });
        const to   = new fabric.Textbox('Bill To:\\nClient Name\\nAddress', { left: cx+120, top: y, width: 240, fontSize: 14, fill:'#ffffff', erasable:true }); y += 90;
        items.push(title, from, to);
        const headers = ['Item','Qty','Price','Amount'];
        const cols = headers.length; const rows = 5; const cellW = 140; const cellH = 34; const startX = cx - (cols*cellW)/2; const startY = y;
        for (let i=0;i<=rows;i++){ const ly = startY + i*cellH; items.push(new fabric.Line([startX, ly, startX + cols*cellW, ly], { stroke:'rgba(255,255,255,0.35)', selectable:false, evented:false, strokeUniform:true })); }
        for (let c=0;c<=cols;c++){ const lx = startX + c*cellW; items.push(new fabric.Line([lx, startY, lx, startY + rows*cellH], { stroke:'rgba(255,255,255,0.35)', selectable:false, evented:false, strokeUniform:true })); }
        headers.forEach((h,i)=>{ items.push(new fabric.Textbox(h, { left: startX + i*cellW + 6, top: startY + 6, width: cellW-12, fontSize: 14, fill:'#ffffff', fontWeight:'600', erasable:true })); });
        for (let r=1; r<rows; r++){
          for (let c=0; c<cols; c++){
            items.push(new fabric.Textbox('', { left: startX + c*cellW + 6, top: startY + r*cellH + 6, width: cellW-12, fontSize: 14, fill:'#ffffff', erasable:true }));
          }
        }
        y = startY + rows*cellH + 20;
        const notes = new fabric.Textbox('Notes', { left: startX, top: y, width: cellW*2, fontSize: 14, fill:'#ffffff', erasable:true });
        const totalLbl = new fabric.Textbox('Total:', { left: startX + cellW*2 + 20, top: y, width: cellW-20, fontSize: 16, fill:'#ffffff', textAlign:'right', erasable:true });
        const totalVal = new fabric.Textbox('$0.00', { left: startX + cellW*3 + 6, top: y, width: cellW-12, fontSize: 16, fill:'#ffffff', erasable:true });
        items.push(notes, totalLbl, totalVal);
        const grp = new fabric.Group(items, { left: 0, top: 0, subTargetCheck: true, objectCaching: false, erasable:true });
        canvas.add(grp);
        canvas.requestRenderAll(); markDirty(); pushHistoryDebounced();
      }

      // Controls
      $('#brushSize').addEventListener('input', (e) => {
        const sz = Number(e.target.value || 3);
        if (canvas.isDrawingMode) canvas.freeDrawingBrush.width = sz;
        const active = canvas.getActiveObjects();
        if (active.length) {
          active.forEach(o => { if (o.type === 'path') o.set({ strokeWidth: sz }); });
          canvas.requestRenderAll(); markDirty(); pushHistoryDebounced();
        }
        const fsBrush = document.getElementById('fsBrush'); if (fsBrush) fsBrush.value = String(sz);
      });
      function applyBrushColor(col){
        try {
          if (state.currentTool === 'erase') return;
          if (canvas.freeDrawingBrush && canvas.freeDrawingBrush.color !== undefined) canvas.freeDrawingBrush.color = col;
        } catch {}
      }
      $('#brushColor').addEventListener('input', (e) => {
        const col = e.target.value || '#ffffff';
        applyBrushColor(col);
        const active = canvas.getActiveObjects();
        if (active.length) { active.forEach(o => applyColor(o, col)); canvas.requestRenderAll(); markDirty(); pushHistoryDebounced(); }
        const fsColor = document.getElementById('fsColor'); if (fsColor) fsColor.value = col;
      });
      const fsColor = document.getElementById('fsColor');
      if (fsColor) {
        try { fsColor.value = document.getElementById('brushColor').value || '#ffffff'; } catch {}
        const onFsColor = (e) => {
          const col = e.target.value || '#ffffff';
          const bc = document.getElementById('brushColor'); if (bc) bc.value = col;
          applyBrushColor(col);
          const active = canvas.getActiveObjects();
          if (active.length) { active.forEach(o => applyColor(o, col)); canvas.requestRenderAll(); markDirty(); }
        };
        fsColor.addEventListener('input', onFsColor);
        fsColor.addEventListener('change', onFsColor);
      }
      const fsBrush = document.getElementById('fsBrush');
      if (fsBrush) {
        try { fsBrush.value = document.getElementById('brushSize').value || '3'; } catch {}
        fsBrush.addEventListener('input', (e) => {
          const sz = Number(e.target.value || 3);
          const main = document.getElementById('brushSize'); if (main) main.value = String(sz);
          if (canvas.isDrawingMode) canvas.freeDrawingBrush.width = sz;
          const active = canvas.getActiveObjects();
          if (active.length) { active.forEach(o => { if (o.type === 'path') o.set({ strokeWidth: sz }); }); canvas.requestRenderAll(); markDirty(); }
        });
      }
      function applyColor(obj, col){
        if (obj.type === 'path') obj.set({ stroke: col });
        else if (obj.type === 'textbox' || obj.type === 'i-text' || obj.type === 'text') obj.set({ fill: col });
        else if (obj.type === 'group' && obj._objects) obj._objects.forEach(ch => applyColor(ch, col));
        else obj.set({ fill: col });
      }
      $('#clearCanvas').addEventListener('click', () => {
        if (confirm('Clear the canvas?')) { canvas.clear(); markDirty(); }
      });
      $('#zoomIn').addEventListener('click', () => setZoom(state.zoom * 1.15));
      $('#zoomOut').addEventListener('click', () => setZoom(state.zoom / 1.15));
      $('#centerCanvas').addEventListener('click', resetViewport);
      $('#zoomLevel').addEventListener('change', (e) => setZoom(clamp((Number(e.target.value)||100)/100, 0.1, 5)));

      // Fullscreen toggle
      const isFullscreen = () => document.body.classList.contains('fs-canvas-on');
      const enterFS = () => { setMode('canvas'); document.body.classList.add('fs-canvas-on','fs-active'); $('#fsToolbarExit').textContent='Exit'; resize(); }
      const exitFS  = () => { document.body.classList.remove('fs-canvas-on','fs-active'); $('#fsToolbarExit').textContent='Full'; resize(); }
      const toggleFS = () => isFullscreen() ? exitFS() : enterFS();
      $('#fsToolbarExit')?.addEventListener('click', toggleFS);
      window.addEventListener('keydown', (e) => { if (e.key === 'Escape' && isFullscreen()) { e.preventDefault(); exitFS(); } });
      function setZoom(z){ state.zoom = clamp(z, 0.1, 5); const c = new fabric.Point(canvas.getWidth()/2, canvas.getHeight()/2); canvas.zoomToPoint(c, state.zoom); $('#zoomLevel').value = Math.round(state.zoom*100); }
      function resetViewport(){ state.zoom = 1; canvas.setViewportTransform([1,0,0,1,0,0]); $('#zoomLevel').value = 100; canvas.requestRenderAll(); }

      // Touch pinch-zoom
      (function enablePinchZoom(){
        const target = canvas.upperCanvasEl;
        let t1=null, t2=null, lastDist=0, lastCenter=null;
        const dist = (a,b)=> Math.hypot(a.clientX-b.clientX, a.clientY-b.clientY);
        const center = (a,b)=> ({ x:(a.clientX+b.clientX)/2, y:(a.clientY+b.clientY)/2 });
        const toPoint = (c)=> new fabric.Point(c.x, c.y);
        target.addEventListener('touchstart', (e)=>{
          if (e.touches.length===2){ t1=e.touches[0]; t2=e.touches[1]; lastDist=dist(t1,t2); lastCenter=center(t1,t2); canvas.isDrawingMode=false; canvas.selection=false; }
        }, { passive:false });
        target.addEventListener('touchmove', (e)=>{
          if (e.touches.length===2){
            e.preventDefault();
            t1=e.touches[0]; t2=e.touches[1];
            const d = dist(t1,t2); const c = center(t1,t2);
            const scale = d / (lastDist || d);
            const newZoom = clamp(canvas.getZoom()*scale, 0.1, 5);
            canvas.zoomToPoint(toPoint(c), newZoom);
            const v = canvas.viewportTransform; v[4] += (c.x - (lastCenter?.x||c.x)); v[5] += (c.y - (lastCenter?.y||c.y));
            canvas.requestRenderAll();
            lastDist = d; lastCenter = c; state.zoom = newZoom; $('#zoomLevel').value = Math.round(state.zoom*100);
          }
        }, { passive:false });
        target.addEventListener('touchend', ()=>{ t1=t2=null; lastDist=0; lastCenter=null; canvas.selection = (state.currentTool==='select'); }, { passive:true });
      })();

      // Grid & BG (BG applied to host, not canvas)
      $('#gridToggle').addEventListener('change', (e) => { state.grid.show = e.target.checked; canvas.requestRenderAll(); });
      $('#snapToggle').addEventListener('change', (e) => { state.grid.snap = e.target.checked; });
      $('#gridSize').addEventListener('change', (e) => { state.grid.size = clamp(Number(e.target.value)||24, 4, 200); canvas.requestRenderAll(); });
      $('#canvasBg').addEventListener('input', (e) => { $('#canvasHost').style.backgroundColor = e.target.value || '#0f0f11'; markDirty(); pushHistoryDebounced(); });

      function useTool(kind){
        state.currentTool = kind;
        canvas.isDrawingMode = false;
        canvas.defaultCursor = 'default';
        canvas.selection = (kind === 'select');

        setToolActive(kind);

        if (kind === 'select') return;

        if (kind === 'draw') {
          canvas.isDrawingMode = true;
          if (!(canvas.freeDrawingBrush instanceof fabric.PencilBrush)) canvas.freeDrawingBrush = new fabric.PencilBrush(canvas);
          canvas.freeDrawingBrush.color = $('#brushColor').value || '#ffffff';
          canvas.freeDrawingBrush.width = Number($('#brushSize').value || 3);
          canvas.defaultCursor = 'crosshair';
          return;
        }

        if (kind === 'text' || kind === 'sticky') { canvas.defaultCursor = 'crosshair'; return; }

        if (kind === 'erase') { setEraseBrush(); return; }
      }

      // start in Move mode
      function setToolActive(tool) {
        const toolBtns = $$('#canvasPanel .tool');
        const fsToolBtns = $$('#fsToolbar [data-tool]');
        toolBtns.forEach(b => b.classList.toggle('tool-active', b.dataset.tool === tool));
        fsToolBtns.forEach(b => b.classList.toggle('tool-active', b.dataset.tool === tool));
      }
      useTool('select');
      pushHistory();
    }

    /* =============== MODE TOGGLE =============== */
    function setMode(m) {
      state.mode = m;
      const panels = { doc:'#docPanel', canvas:'#canvasPanel', settings:'#settingsPanel' };
      Object.values(panels).forEach(sel => $(sel).classList.add('hidden'));
      $(panels[m]).classList.remove('hidden');

      // Update segmented control
      $('#modeDoc').classList.toggle('bg-white/10', m==='doc');
      $('#modeCanvas').classList.toggle('bg-white/10', m==='canvas');
      $('#modeSettings').classList.toggle('bg-white/10', m==='settings');

      const mb = $('#mbMode'); if (mb) mb.textContent = m==='doc' ? 'Doc' : (m==='canvas' ? 'Canvas' : 'Settings');

      if (m==='doc') { try { window.ocFitDoc && window.ocFitDoc(); } catch {} }
      if (m==='canvas') { state.canvas && state.canvas.requestRenderAll(); }
      if (m==='settings') { applySettingsToUI(); }
    }

    /* =============== SNAPSHOTS / SAVE / LOAD =============== */
    function getSnapshot() {
      const title = ($('#docTitle').value || '').trim() || 'Untitled note';
      const docHTML = state.quill ? state.quill.root.innerHTML : '';
      let canvasJSON = null, canvasPNG = null, canvasBG = null;
      if (state.canvas) {
        canvasJSON = state.canvas.toJSON(['selectable','evented','stroke','strokeWidth','fill','fontSize','backgroundColor','padding','rx','ry','strokeUniform','globalCompositeOperation']);
        try { canvasPNG = state.canvas.toDataURL({ format:'png', multiplier: 2, quality: 1.0 }); } catch { canvasPNG = null; }
        canvasBG = $('#canvasBg')?.value || '#0f0f11';
      }
      return { id: state.id, title, updatedAt: nowISO(), docHTML, canvasJSON, canvasPNG, canvasBG, version: 6 };
    }
    function applySnapshot(snap) {
      state.id = snap.id || uid();
      $('#docTitle').value = snap.title || 'Untitled note';
      if (state.quill) state.quill.root.innerHTML = snap.docHTML || '';
      if (state.canvas && snap.canvasJSON) {
        state.suppressHistory = true;
        state.canvas.loadFromJSON(snap.canvasJSON, () => {
          $('#canvasBg').value = snap.canvasBG || '#0f0f11';
          $('#canvasHost').style.backgroundColor = snap.canvasBG || '#0f0f11';
          state.canvas.requestRenderAll();
          try {
            const SAVE_PROPS = ['selectable','evented','stroke','strokeWidth','fill','fontSize','backgroundColor','padding','rx','ry','strokeUniform','globalCompositeOperation','eraser'];
            const initial = { json: state.canvas.toJSON(SAVE_PROPS) };
            state.hist.stack = [initial]; state.hist.idx = 0;
          } catch {}
          state.suppressHistory = false;
        });
      }
      clearDirty();
      refreshSidebarUI();
    }
    function newDocument() {
      if (state.dirty && !confirm('Discard unsaved changes?')) return;
      state.id = uid();
      $('#docTitle').value = 'Untitled note';
      state.quill.root.innerHTML = '';
      if (state.canvas) {
        state.canvas.clear();
        const bg = $('#canvasBg').value || '#0f0f11';
        $('#canvasHost').style.backgroundColor = bg;
        try {
          const SAVE_PROPS = ['selectable','evented','stroke','strokeWidth','fill','fontSize','backgroundColor','padding','rx','ry','strokeUniform','globalCompositeOperation','eraser'];
          const initial = { json: state.canvas.toJSON(SAVE_PROPS) };
          state.hist.stack = [initial]; state.hist.idx = 0;
        } catch {}
      }
      clearDirty();
      const snap = getSnapshot();
      store.upsert(snap);
      refreshHistoryUI();
      refreshSidebarUI();
    }
    function saveDocument() {
      const snap = getSnapshot();
      store.upsert(snap); clearDirty(); flash('Saved'); refreshHistoryUI(); refreshSidebarUI();
    }
    const autoSave = debounce(() => { if (state.dirty) saveDocument(); }, 1500);
    const openFromChooser = () => $('#openFile').click();
    function importProject(file) {
      const reader = new FileReader();
      reader.onload = () => {
        try { const data = JSON.parse(reader.result); applySnapshot(data); saveDocument(); }
        catch(e){ alert('Invalid file.'); }
      };
      reader.readAsText(file);
    }

    /* =============== EXPORT BUILDERS =============== */
    function buildStandaloneHTML(snap) {
      const css = `
        meta[charset]{}
        body{ font-family:-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif; color:#111; margin:40px; line-height:1.6; }
        h1{ font-size:28px; margin:0 0 16px; }
        h2{ font-size:20px; margin:24px 0 8px; }
        .doc{ font-size:16px; }
        img.canvas-shot{ max-width:100%; height:auto; margin:16px 0; border:1px solid #e5e5e5; border-radius:8px; }
        .hr{ height:1px; background:#e5e5e5; margin:24px 0; }
        .ql-align-center{text-align:center} .ql-align-right{text-align:right} .ql-align-justify{text-align:justify}
        .ql-indent-1{margin-left:3em} .ql-indent-2{margin-left:6em} .ql-indent-3{margin-left:9em}
      `;
      const docWrapped = `<div class="doc">${snap.docHTML || ''}</div>`;
      const canvasPart = snap.canvasPNG ? `<div class="hr"></div><h2>Canvas</h2><img class="canvas-shot" src="${snap.canvasPNG}" alt="Canvas snapshot" />` : '';
      return `<!DOCTYPE html><html><head><meta charset="utf-8"><title>${escapeHtml(snap.title)}</title><style>${css}</style></head><body>
        <h1>${escapeHtml(snap.title)}</h1>
        ${docWrapped}
        ${canvasPart}
      </body></html>`;
    }

    /* =============== EXPORT ACTIONS =============== */
    async function exportDocx() {
      try {
        const snap = getSnapshot();
        const html = buildStandaloneHTML(snap);
        let blob = window.htmlDocx.asBlob(html, {
          orientation: 'portrait',
          margins: { top: 720, right: 720, bottom: 720, left: 720 }
        });
        if (!blob.type || blob.type === 'application/octet-stream') {
          blob = new Blob([blob], { type: 'application/vnd.openxmlformats-officedocument.wordprocessingml.document' });
        }
        await downloadBlob(blob, safeFileName(snap.title)+'.docx');
        flash('Exported .docx');
      } catch (err) {
        console.error('DOCX export failed', err);
        alert('DOCX export failed. Error: ' + (err?.message || err));
      }
    }
    async function exportPDF() {
      const snap = getSnapshot();
      const html = buildStandaloneHTML(snap);
      await html2pdf().set({
        margin: [10,10,10,10],
        filename: safeFileName(snap.title)+'.pdf',
        image: { type: 'jpeg', quality: 0.98 },
        html2canvas: { scale: 2, useCORS: true, backgroundColor: '#ffffff' },
        jsPDF: { unit: 'mm', format: 'letter', orientation: 'portrait' }
      }).from(html).save();
      flash('Exported .pdf');
    }
    function exportHTML() {
      const snap = getSnapshot();
      const html = buildStandaloneHTML(snap);
      const blob = new Blob([html], {type:'text/html;charset=utf-8'});
      downloadBlob(blob, safeFileName(snap.title)+'.html');
      flash('Exported .html');
    }
    function exportJSON() {
      const snap = getSnapshot();
      const blob = new Blob([JSON.stringify(snap,null,2)], {type:'application/json'});
      downloadBlob(blob, safeFileName(snap.title)+'.ocnote');
      flash('Exported .ocnote');
    }

    /* =============== HISTORY UI =============== */
    function openHistory(){ $('#historyDrawer').classList.remove('hidden'); document.body.style.overflow='hidden'; refreshHistoryUI(); }
    function closeHistory(){ $('#historyDrawer').classList.add('hidden'); document.body.style.overflow=''; }
    function refreshHistoryUI() {
      const list = store.loadAll();
      const q = ($('#searchHistory').value || '').toLowerCase();
      const holder = $('#historyList'); holder.innerHTML = '';
      list.filter(item => !q || (item.title?.toLowerCase().includes(q) || (item.docHTML||'').toLowerCase().includes(q)))
          .forEach(item => {
            const row = document.createElement('div');
            row.className = 'glass rounded-xl border p-3 hover:bg-white/10 transition';
            row.style.borderColor = getComputedStyle(document.body).getPropertyValue('--line');
            row.innerHTML = `
              <div class="flex items-center justify-between gap-3">
                <div class="min-w-0">
                  <div class="font-medium truncate" style="color:var(--text)">${escapeHtml(item.title||'Untitled')}</div>
                  <div class="text-xs" style="color:var(--muted)">${niceDate(item.updatedAt)}</div>
                </div>
                <div class="flex items-center gap-2 flex-shrink-0">
                  <button class="px-2 py-1 glass-2 hover:bg-white/20 rounded-lg text-xs border" data-open-id="${item.id}" style="border-color:var(--line)">Open</button>
                  <button class="px-2 py-1 glass-2 hover:bg-white/20 rounded-lg text-xs border" data-download-id="${item.id}" style="border-color:var(--line)">Export .ocnote</button>
                </div>
              </div>`;
            holder.appendChild(row);
          });
      holder.querySelectorAll('[data-open-id]').forEach(btn => btn.addEventListener('click', (e) => {
        e.stopPropagation(); const id = btn.getAttribute('data-open-id');
        const item = store.loadAll().find(x => x.id===id);
        if (item){ applySnapshot(item); closeHistory(); }
      }));
      holder.querySelectorAll('[data-download-id]').forEach(btn => btn.addEventListener('click', (e) => {
        e.stopPropagation(); const id = btn.getAttribute('data-download-id');
        const item = store.loadAll().find(x => x.id===id);
        if (item){
          const blob = new Blob([JSON.stringify(item,null,2)], {type:'application/json'});
          downloadBlob(blob, safeFileName(item.title)+'.ocnote');
        }
      }));
    }

    /* =============== SIDEBAR UI (Desktop) =============== */
    function refreshSidebarUI() {
      const list = store.loadAll();
      const q = ($('#sidebarSearch').value || '').toLowerCase();
      const holder = $('#sidebarList'); if (!holder) return; holder.innerHTML = '';
      const currentId = state.id;
      list.filter(item => !q || (item.title?.toLowerCase().includes(q) || (item.docHTML||'').toLowerCase().includes(q)))
          .forEach(item => {
            const row = document.createElement('div');
            row.className = 'note-row glass-2 rounded-xl border p-3 transition';
            row.style.borderColor = getComputedStyle(document.body).getPropertyValue('--line');
            if (item.id === currentId) row.classList.add('active');
            row.innerHTML = `
              <div class="text-sm font-medium truncate" style="color:var(--text)">${escapeHtml(item.title||'Untitled')}</div>
              <div class="text-[11px] mt-0.5" style="color:var(--muted)">${niceDate(item.updatedAt)}</div>
            `;
            row.addEventListener('click', () => { applySnapshot(item); refreshSidebarUI(); });
            holder.appendChild(row);
          });
    }

    /* =============== MENUS / SHORTCUTS =============== */
    function wireMenus() {
      const expBtn = $('#exportBtn'), expMenu = $('#exportMenu');

      function positionPortalMenu(btn, menu){
        const r = btn.getBoundingClientRect();
        menu.style.top = (r.bottom + 8) + 'px';
        const menuW = menu.offsetWidth || 224;
        const left = Math.min(Math.max(12, r.right - menuW), window.innerWidth - menuW - 12);
        menu.style.left = left + 'px';
      }
      function openExportMenu(){
        expMenu.innerHTML = `
          <div role="menu" aria-label="Export options">
            <button class="menu-item" data-export="docx">Export as .docx (Word)</button>
            <button class="menu-item" data-export="pdf">Export as .pdf</button>
            <button class="menu-item" data-export="html">Export as .html</button>
            <button class="menu-item" data-export="json">Export project (.ocnote)</button>
          </div>`;
        expMenu.classList.remove('hidden');
        expBtn.setAttribute('aria-expanded','true');
        // ensure dimensions before positioning
        requestAnimationFrame(()=>positionPortalMenu(expBtn, expMenu));
      }
      function closeExportMenu(){
        expMenu.classList.add('hidden');
        expBtn.setAttribute('aria-expanded','false');
      }

      expBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        if (expMenu.classList.contains('hidden')) openExportMenu();
        else closeExportMenu();
      });
      document.addEventListener('click', (e) => {
        if (!expMenu.classList.contains('hidden')) closeExportMenu();
      });
      document.addEventListener('keydown', (e) => { if (e.key === 'Escape') closeExportMenu(); });

      expMenu.addEventListener('click', (ev) => {
        const btn = ev.target.closest('[data-export]'); if (!btn) return;
        closeExportMenu();
        const k = btn.getAttribute('data-export');
        if (k==='docx') exportDocx();
        if (k==='pdf')  exportPDF();
        if (k==='html') exportHTML();
        if (k==='json') exportJSON();
      });

      // History drawer
      $$('#historyDrawer [data-close-history]').forEach(el => el.addEventListener('click', closeHistory));
      document.addEventListener('keydown', (e) => { if (e.key === 'Escape') closeHistory(); });

      // Sidebar & Drawer new
      $('#sbNew')?.addEventListener('click', newDocument);
      $('#drawerNew')?.addEventListener('click', newDocument);

      // Drawer export taps
      $$('#historyDrawer [data-drawer-export]').forEach(btn => btn.addEventListener('click', () => {
        const k = btn.getAttribute('data-drawer-export');
        if (k==='docx') exportDocx();
        if (k==='pdf')  exportPDF();
        if (k==='html') exportHTML();
        if (k==='json') exportJSON();
      }));
    }
    function wireShortcuts() {
      window.addEventListener('keydown', (e) => {
        const isMeta = e.ctrlKey || e.metaKey;
        if (isMeta && e.key.toLowerCase()==='s'){ e.preventDefault(); saveDocument(); }
        if (isMeta && e.key.toLowerCase()==='p'){ e.preventDefault(); exportPDF(); }
      });
    }

    /* =============== DOC FIT (Apple-clean scaling) =============== */
    function fitDoc(){
      const wrap = $('#pageWrap'); if (!wrap) return;
      const page = $('#page'); if (!page) return;
      const headerEl = document.querySelector('header');
      const tb = $('#quillToolbar');
      const titleSec = $('#docTitle')?.closest('section');
      const hH = headerEl?.offsetHeight || 0;
      const tH = tb?.offsetHeight || 0;
      const titleH = titleSec?.offsetHeight || 0;
      const availH = Math.max(400, window.innerHeight - hH - tH - titleH - 48);
      const availW = Math.max(320, wrap.clientWidth);
      const scale = Math.min(availW / 816, availH / 1056, 1);
      state.docScale = scale;
      page.style.transform = `scale(${scale})`;
      wrap.style.minHeight = Math.ceil(1056 * scale + 24) + 'px';
    }
    window.ocFitDoc = fitDoc;

    /* =============== SETTINGS WIRING =============== */
    function wireSettings(){
      const range = $('#setMobilePad'), num = $('#setMobilePadNumber');
      const applyInputsToState = () => {
        const v = clamp(Number(range.value||state.settings.mobileSidePad), 8, 28);
        state.settings.mobileSidePad = v;
        num.value = String(v);
      };
      const syncRangeNum = (from) => {
        const v = clamp(Number(from.value||state.settings.mobileSidePad), 8, 28);
        range.value = String(v); num.value = String(v);
      };
      range?.addEventListener('input', () => { applyInputsToState(); document.documentElement.style.setProperty('--mobile-side-pad', state.settings.mobileSidePad + 'px'); fitDoc(); });
      num?.addEventListener('input', () => { syncRangeNum(num); document.documentElement.style.setProperty('--mobile-side-pad', num.value + 'px'); fitDoc(); });

      $('#densityCozy')?.addEventListener('click', () => { state.settings.density='cozy'; applySettingsToUI(); });
      $('#densityCompact')?.addEventListener('click', () => { state.settings.density='compact'; applySettingsToUI(); });

      $('#settingsApply')?.addEventListener('click', () => { store.saveSettings(state.settings); flash('Settings saved'); fitDoc(); });
      $('#settingsBack')?.addEventListener('click', () => setMode('doc'));
    }

    /* =============== BOOT =============== */
    function boot() {
      applyTheme(store.loadTheme() || 'dark');
      applySettingsToUI();
      initQuill();
      initCanvas();

      // header controls
      $('#modeDoc').addEventListener('click', () => setMode('doc'));
      $('#modeCanvas').addEventListener('click', () => setMode('canvas'));
      $('#modeSettings').addEventListener('click', () => setMode('settings'));

      $('#newBtn').addEventListener('click', newDocument);
      $('#saveBtn').addEventListener('click', saveDocument);
      $('#openBtn').addEventListener('click', openFromChooser);
      $('#openFile').addEventListener('change', (e) => { const f = e.target.files?.[0]; if (f) importProject(f); e.target.value=''; });

      // history
      $('#menuBtn')?.addEventListener('click', openHistory);
      $('#searchHistory').addEventListener('input', debounce(refreshHistoryUI, 120));
      $('#sidebarSearch')?.addEventListener('input', debounce(refreshSidebarUI, 120));

      // title dirty tracking
      const titleEl = $('#docTitle'); titleEl.addEventListener('input', markDirty);
      titleEl.addEventListener('focus', () => { if (titleEl.value.trim() === 'Untitled note') { titleEl.value = ''; } });

      // theme
      $('#themeBtn').addEventListener('click', toggleTheme);

      // Mobile bar wiring
      $('#mbNew')?.addEventListener('click', newDocument);
      $('#mbSave')?.addEventListener('click', saveDocument);
      $('#mbExport')?.addEventListener('click', (e)=>{ e.stopPropagation(); $('#exportBtn')?.click(); });
      $('#mbMode')?.addEventListener('click', ()=> setMode(state.mode==='doc' ? 'canvas' : (state.mode==='canvas' ? 'settings' : 'doc')));
      $('#mbTheme')?.addEventListener('click', toggleTheme);

      wireSettings();
      wireMenus();
      wireShortcuts();

      // autosave
      setInterval(()=>{ if (state.dirty) saveDocument(); }, 30000);
      document.addEventListener('visibilitychange', () => { if (document.visibilityState === 'hidden' && state.dirty) { try { const snap = getSnapshot(); store.upsert(snap); clearDirty(); } catch {} } });
      window.addEventListener('beforeunload', () => { if (state.dirty) { try { const snap = getSnapshot(); store.upsert(snap); } catch {} } });

      setMode('doc');
      refreshHistoryUI();
      refreshSidebarUI();

      // measure header height to position sidebar
      const header = document.querySelector('header');
      if (header) document.documentElement.style.setProperty('--topbar-h', header.offsetHeight + 'px');

      // sidebar state
      state.sidebarOpen = store.loadSidebarOpen();
      const applySidebarPadding = () => {
        const wide = window.innerWidth >= 1024;
        if (wide && state.sidebarOpen) { document.body.classList.add('with-sidebar'); document.body.classList.remove('sidebar-collapsed'); }
        else { document.body.classList.remove('with-sidebar'); document.body.classList.add('sidebar-collapsed'); }
      };
      applySidebarPadding();
      window.addEventListener('resize', debounce(() => { applySidebarPadding(); fitDoc(); }, 120));
      $('#toggleSidebar')?.addEventListener('click', () => { state.sidebarOpen = !state.sidebarOpen; store.saveSidebarOpen(state.sidebarOpen); applySidebarPadding(); fitDoc(); });

      // Ensure page fits viewport like Word (always one 8.5x11 on screen)
      fitDoc();

      // PWA service worker
      if ('serviceWorker' in navigator) {
        try { navigator.serviceWorker.register('./sw.js'); } catch(e) { console.warn('SW registration failed', e); }
      }
    }

    document.addEventListener('DOMContentLoaded', boot);
  </script>

  <!-- Mobile bottom bar -->
  <nav class="mobile-bar fixed left-1/2 -translate-x-1/2 bottom-3 safe-pad-bottom px-2 py-1.5 glass border rounded-2xl shadow-lg flex items-center gap-1 z-[70]" style="border-color:var(--line); display:none">
    <button id="mbNew" class="px-2 py-1.5 text-sm rounded-xl hover:bg-white/10 flex items-center" aria-label="New">
      <span class="plus-glow" aria-hidden="true"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round"><path d="M12 5v14M5 12h14"/></svg></span>
    </button>
    <button id="mbMode" class="px-3 py-2 text-sm rounded-xl hover:bg-white/10" aria-label="Toggle mode">Doc</button>
    <button id="mbTheme" class="px-3 py-2 text-sm rounded-xl hover:bg-white/10" aria-label="Toggle theme">â˜€ï¸Ž/ðŸŒ™</button>
  </nav>
</body>
</html>
